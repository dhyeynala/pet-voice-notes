<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>PetPulse - Pet Health Management</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
      background-size: 300% 300%;
      animation: gradientShift 15s ease infinite;
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                  radial-gradient(circle at 40% 40%, rgba(120, 200, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 
                  0 2px 8px rgba(102, 126, 234, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8rem;
      font-weight: 700;
      color: #667eea;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      position: relative;
    }

    .logo::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s ease;
    }

    .logo:hover::after {
      width: 100%;
    }

    .logo:hover {
      transform: scale(1.05);
      text-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .logo span:first-child {
      font-size: 2rem;
      filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    .nav-menu {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(20px);
      padding: 8px;
      border-radius: 24px;
      border: 1px solid rgba(225, 232, 237, 0.6);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
    }

    .nav-menu::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.6s ease;
    }

    .nav-menu:hover::before {
      left: 100%;
    }

    .nav-item {
      padding: 14px 22px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      background: transparent;
      border: 2px solid transparent;
      position: relative;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .nav-item:hover::before {
      left: 100%;
    }

    .nav-item:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    .nav-item.active:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    .nav-item i {
      font-size: 1rem;
      width: 18px;
      text-align: center;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-left: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, #ff5252, #e53e3e);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
    }

    .section {
      display: none;
      animation: fadeInUp 0.6s ease-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      text-align: center;
      margin-bottom: 50px;
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      padding: 40px 30px;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .section-header h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4ecdc4 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      display: inline-block;
      text-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }

    .section-header h1::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    .section-header p {
      color: #4a5568;
      font-size: 1.2rem;
      font-weight: 500;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    .section-header h2 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4ecdc4 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      display: inline-block;
      text-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }

    .section-header p {
      color: #7f8c8d;
      font-size: 1.1rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1),
                  0 2px 8px rgba(102, 126, 234, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 36px;
      margin-bottom: 30px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #4ecdc4, #f093fb);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.6s ease;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
                  0 8px 32px rgba(102, 126, 234, 0.2);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover::after {
      left: 100%;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 28px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 2px solid #f1f3f4;
      padding-bottom: 15px;
      position: relative;
      text-transform: none;
      letter-spacing: 0.3px;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2, #4ecdc4);
      transition: width 0.8s ease;
      border-radius: 2px;
    }

    .section-title:hover::after {
      width: 80px;
    }

    .section-title i {
      color: #667eea;
      font-size: 1.4rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: float 3s ease-in-out infinite;
    }

    .pet-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .select-wrapper {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid rgba(225, 232, 237, 0.8);
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
      cursor: pointer;
      appearance: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    select:hover {
      border-color: rgba(102, 126, 234, 0.5);
    }

    .select-wrapper::after {
      content: '\f107';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #7f8c8c;
      pointer-events: none;
    }

    input[type="text"] {
      padding: 16px 20px;
      border: 2px solid rgba(225, 232, 237, 0.8);
      border-radius: 16px;
      font-size: 1rem;
      flex: 1;
      min-width: 150px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 
                  0 4px 16px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 1);
    }

    input[type="text"]:hover {
      border-color: rgba(102, 126, 234, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    textarea {
      width: 100%;
      padding: 20px;
      border: 2px solid rgba(225, 232, 237, 0.8);
      border-radius: 16px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      min-height: 140px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15),
                  0 4px 16px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 1);
    }

    textarea:hover {
      border-color: rgba(102, 126, 234, 0.6);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      text-transform: none;
      letter-spacing: 0.3px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover::after {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
      background-size: 200% 200%;
      color: white;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      animation: gradientShiftBtn 3s ease infinite;
    }

    @keyframes gradientShiftBtn {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(102, 126, 234, 0.6);
      animation-play-state: paused;
    }

    .btn-secondary {
      background: rgba(225, 232, 237, 0.8);
      color: #2c3e50;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(209, 217, 224, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: white;
      box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #3db7b0 0%, #3a8f7c 100%);
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(78, 205, 196, 0.5);
    }

    .quick-question-btn {
      font-size: 0.95rem; 
      padding: 14px 24px; 
      border-radius: 16px; 
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(78, 205, 196, 0.1)); 
      border: 2px solid rgba(102, 126, 234, 0.2); 
      color: #667eea; 
      font-weight: 600;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      text-transform: none;
    }

    .quick-question-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
      transition: left 0.6s ease;
    }

    .quick-question-btn:hover::before {
      left: 100%;
    }

    .quick-question-btn:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(78, 205, 196, 0.2));
      border-color: rgba(102, 126, 234, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      color: #5a67d8;
    }

    .record-button {
      width: 100%;
      padding: 20px;
      font-size: 1.1rem;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .record-button.recording {
      background: #ff6b6b !important;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
    }

    .status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }

    .status.recording {
      background: #fff5f5;
      color: #e53e3e;
      border: 1px solid #fed7d7;
      display: block;
    }

    .status.processing {
      background: #fef5e7;
      color: #d69e2e;
      border: 1px solid #fbd38d;
      display: block;
    }

    .status.success {
      background: #f0fff4;
      color: #38a169;
      border: 1px solid #9ae6b4;
      display: block;
    }

    .status.error {
      background: #fff5f5;
      color: #e53e3e;
      border: 1px solid #fed7d7;
      display: block;
    }

    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 500;
      display: none;
    }

    .status-message.success {
      background: #f0fff4;
      color: #38a169;
      border: 1px solid #9ae6b4;
      display: block;
    }

    .status-message.error {
      background: #fff5f5;
      color: #e53e3e;
      border: 1px solid #fed7d7;
      display: block;
    }

    .output {
      background: #f7fafc;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      padding: 20px;
      min-height: 100px;
      font-size: 0.95rem;
      line-height: 1.6;
      display: none;
    }

    .output.has-content {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .result-box {
      background: #f7fafc;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
      display: none;
    }

    .result-box.has-content {
      display: block;
    }

    .output h3 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 1rem;
      font-weight: 600;
    }

    .transcript {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .summary {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4ecdc4;
    }

    .add-pet-form {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    .file-upload {
      border: 2px dashed #e1e8ed;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #f8fafc;
    }

    .file-upload:hover {
      border-color: #667eea;
      background: #f1f3f4;
    }

    .file-upload.dragover {
      border-color: #667eea;
      background: #eef2ff;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .upload-icon {
      font-size: 2rem;
      color: #667eea;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #7f8c8d;
      font-size: 1rem;
    }

    .upload-text strong {
      color: #2c3e50;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 768px) {
      .nav-menu {
        flex-direction: column;
        gap: 8px;
        background: #f8fafc;
        padding: 8px;
        border-radius: 16px;
        border: 1px solid #e1e8ed;
        width: 100%;
      }

      .nav-item {
        padding: 12px 16px;
        font-size: 0.9rem;
        width: 100%;
        justify-content: center;
      }

      .logout-btn {
        margin-left: 0;
        margin-top: 15px;
        width: 100%;
        justify-content: center;
      }

      .header-content {
        flex-direction: column;
        gap: 20px;
      }

      .section-header h1 {
        font-size: 2rem;
      }

      .pet-controls {
        flex-direction: column;
      }

      .add-pet-form {
        flex-direction: column;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      #dashboard-summary {
        grid-template-columns: 1fr;
      }

      #charts-container > div {
        grid-template-columns: 1fr;
      }

      .tab-btn {
        font-size: 0.8rem;
        padding: 10px 15px;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Analytics Specific Styles */
    .metric-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      border: 2px solid rgba(225, 232, 237, 0.6);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .metric-card:hover::before {
      left: 100%;
    }

    .metric-card:hover {
      border-color: #667eea;
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.2);
      background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(248, 250, 252, 0.95));
    }

    .metric-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .metric-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 800;
      color: #2c3e50;
      background: linear-gradient(135deg, #2c3e50, #667eea);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #e1e8ed;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .chart-container h4 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .tab-navigation {
      overflow-x: auto;
      white-space: nowrap;
    }

    .tab-btn {
      background: rgba(248, 250, 252, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(225, 232, 237, 0.6);
      border-radius: 16px;
      padding: 14px 24px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-right: 12px;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      transition: left 0.6s ease;
    }

    .tab-btn:hover::before {
      left: 100%;
    }

    .tab-btn:hover {
      border-color: #667eea;
      background: rgba(240, 244, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.15);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
    }

    .tab-btn.active:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .analytics-form {
      background: #f9fafb;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #e1e8ed;
    }

    .analytics-form h4 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .energy-selector {
      position: relative;
    }

    .energy-selector input[type="range"] {
      width: 100%;
      margin-bottom: 10px;
    }

    .energy-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    select[multiple] {
      height: auto;
      min-height: 80px;
    }

    .recent-entry {
      background: white;
      border: 1px solid #e1e8ed;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .recent-entry:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .entry-content {
      flex: 1;
    }

    .entry-category {
      font-size: 0.8rem;
      color: #667eea;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .entry-description {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 3px;
    }

    .entry-time {
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    .entry-icon {
      font-size: 1.5rem;
      color: #667eea;
      margin-left: 15px;
    }

    .daily-headline {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      backdrop-filter: blur(10px);
    }

    .daily-headline:last-child {
      margin-bottom: 0;
    }

    .headline-icon {
      display: inline-block;
      margin-right: 10px;
      font-size: 1.2rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced styling for new features */
    .mood-selector {
      text-align: center;
    }

    .mood-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    .mood-labels span {
      font-size: 0.9rem;
    }

    .insight-section {
      margin-bottom: 20px;
    }

    .insight-section h4 {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insight-section ul {
      list-style: none;
      padding: 0;
    }

    .insight-section li {
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid currentColor;
    }

    .alert-section li {
      background: #fff5f5;
      border-left-color: #e53e3e;
    }

    .tab-btn {
      font-size: 0.9rem;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .tab-btn i {
        display: none;
      }

      .tab-btn {
        font-size: 0.8rem;
        padding: 8px 12px;
      }
    }

    .content-type-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-medical {
      background: #ffe6e6;
      color: #d63031;
      border: 1px solid #fab1a0;
    }
    
    .badge-activity {
      background: linear-gradient(135deg, #fff3e6, #fff8e1);
      color: #f39c12;
      border: 1px solid #f39c12;
      box-shadow: 0 2px 4px rgba(243, 156, 18, 0.1);
    }
    
    .badge-mixed {
      background: #f0e6ff;
      color: #6c5ce7;
      border: 1px solid #a29bfe;
    }

    /* Enhanced Visual Effects */
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200px 100%;
      animation: shimmer 2s infinite;
    }

    /* Improved Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(241, 243, 244, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 10px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #5a67d8, #6c5b7b);
    }

    /* Selection styling */
    ::selection {
      background: rgba(102, 126, 234, 0.3);
      color: #2c3e50;
    }

    /* Enhanced Focus States & Accessibility */
    *:focus {
      outline: 2px solid rgba(102, 126, 234, 0.4);
      outline-offset: 2px;
    }

    /* Focus indicators for specific elements */
    .btn:focus,
    .nav-item:focus,
    .tab-btn:focus {
      outline: 3px solid rgba(102, 126, 234, 0.6);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }

    /* Loading states for buttons */
    .btn.loading {
      pointer-events: none;
      position: relative;
      color: transparent !important;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Form validation styles */
    .form-group.error input,
    .form-group.error select,
    .form-group.error textarea {
      border-color: #e53e3e;
      box-shadow: 0 0 0 4px rgba(229, 62, 62, 0.1);
    }

    .form-group.success input,
    .form-group.success select,
    .form-group.success textarea {
      border-color: #38a169;
      box-shadow: 0 0 0 4px rgba(56, 161, 105, 0.1);
    }

    .form-error {
      color: #e53e3e;
      font-size: 0.875rem;
      margin-top: 4px;
      display: none;
    }

    .form-error.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Tooltip styles */
    .tooltip {
      position: relative;
      cursor: help;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .tooltip:hover::after {
      opacity: 1;
    }

    /* Progress indicators */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(225, 232, 237, 0.5);
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* Enhanced feedback for interactions */
    .feedback-success {
      background: linear-gradient(135deg, #f0fff4, #e6fffa);
      border: 1px solid #9ae6b4;
      color: #38a169;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    .feedback-error {
      background: linear-gradient(135deg, #fff5f5, #fef7f7);
      border: 1px solid #fed7d7;
      color: #e53e3e;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Skeleton loading for content */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200px 100%;
      animation: shimmer 2s infinite;
      border-radius: 4px;
    }

    .skeleton-text {
      height: 1rem;
      margin-bottom: 0.5rem;
    }

    .skeleton-text:last-child {
      width: 80%;
    }

    /* Smart form enhancements */
    .form-group {
      position: relative;
      margin-bottom: 24px;
    }

    .floating-label {
      position: absolute;
      top: 16px;
      left: 18px;
      color: #7f8c8d;
      transition: all 0.3s ease;
      pointer-events: none;
      background: white;
      padding: 0 4px;
    }

    .floating-label.active,
    input:focus ~ .floating-label,
    input:not(:placeholder-shown) ~ .floating-label {
      top: -8px;
      font-size: 0.75rem;
      color: #667eea;
      font-weight: 500;
    }

    /* Copy to clipboard feedback */
    .copy-feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .copy-feedback.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Loading animation for cards */
    .card-loading {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.9) 25%, rgba(248, 250, 252, 0.5) 50%, rgba(255, 255, 255, 0.9) 75%);
      background-size: 200px 100%;
      animation: shimmer 2s infinite;
    }

    /* Real-time status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-indicator.online {
      background: rgba(56, 161, 105, 0.1);
      color: #38a169;
    }

    .status-indicator.saving {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .status-indicator.error {
      background: rgba(229, 62, 62, 0.1);
      color: #e53e3e;
    }

    /* Enhanced micro-interactions */
    .clickable {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clickable:hover {
      transform: scale(1.02);
    }

    .clickable:active {
      transform: scale(0.98);
    }

    /* Improved empty states */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .empty-state p {
      margin-bottom: 20px;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Smart loading placeholders */
    .content-placeholder {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
    }

    .content-placeholder .skeleton-line {
      height: 12px;
      background: #f0f0f0;
      border-radius: 6px;
      animation: shimmer 2s infinite;
    }

    .content-placeholder .skeleton-line:nth-child(1) { width: 80%; }
    .content-placeholder .skeleton-line:nth-child(2) { width: 100%; }
    .content-placeholder .skeleton-line:nth-child(3) { width: 60%; }

    /* Micro-interactions */
    .interactive:hover {
      transform: translateY(-1px);
      transition: transform 0.2s ease;
    }

    /* Glass morphism containers */
    .glass {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    /* Status indicators */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .status-dot.active {
      background: #38a169;
      box-shadow: 0 0 8px rgba(56, 161, 105, 0.4);
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.inactive {
      background: #e53e3e;
    }

    /* Notification enhancement */
    .notification {
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Improved typography */
    h1, h2, h3, h4, h5, h6 {
      text-rendering: optimizeLegibility;
    }

    body {
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Enhanced button hover states */
    .btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* Enhanced UX Improvements */
    
    /* Smart Loading States */
    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .loading-dots::after {
      content: '';
      animation: loadingDots 1.5s infinite;
    }

    @keyframes loadingDots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* Contextual Notifications */
    .notification-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 400px;
      padding: 16px 20px;
      border-radius: 12px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transform: translateX(100%);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification-toast.show {
      transform: translateX(0);
    }

    .notification-toast.success {
      background: linear-gradient(135deg, rgba(56, 161, 105, 0.9), rgba(72, 187, 120, 0.9));
      border-color: rgba(154, 230, 180, 0.5);
    }

    .notification-toast.error {
      background: linear-gradient(135deg, rgba(229, 62, 62, 0.9), rgba(245, 101, 101, 0.9));
      border-color: rgba(252, 165, 165, 0.5);
    }

    .notification-toast.info {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 169, 250, 0.9));
      border-color: rgba(191, 219, 254, 0.5);
    }

    .notification-toast.warning {
      background: linear-gradient(135deg, rgba(214, 158, 46, 0.9), rgba(245, 158, 11, 0.9));
      border-color: rgba(253, 230, 138, 0.5);
    }

    /* Smart Form Enhancements */
    .form-step {
      opacity: 0.5;
      pointer-events: none;
      transition: all 0.3s ease;
    }

    .form-step.active {
      opacity: 1;
      pointer-events: auto;
    }

    .form-step.completed {
      opacity: 0.8;
    }

    .field-hint {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .form-group:hover .field-hint {
      opacity: 1;
    }

    /* Interactive Feedback */
    .success-checkmark {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #38a169;
      position: relative;
      animation: checkmarkBounce 0.6s ease;
    }

    .success-checkmark::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    @keyframes checkmarkBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Smart Auto-Save Indicators */
    .auto-save-status {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #38a169;
      border: 2px solid white;
      opacity: 0;
      transition: all 0.3s ease;
      animation: saveIndicator 2s ease;
    }

    @keyframes saveIndicator {
      0%, 100% { opacity: 0; transform: scale(1); }
      20% { opacity: 1; transform: scale(1.2); }
      80% { opacity: 1; transform: scale(1); }
    }

    /* Predictive Search */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(225, 232, 237, 0.6);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .search-suggestions.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(225, 232, 237, 0.3);
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .suggestion-item:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Smart Contextual Help */
    .contextual-help {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 999;
    }

    .contextual-help:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 40px rgba(102, 126, 234, 0.6);
    }

    .help-tooltip {
      position: absolute;
      bottom: 70px;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.875rem;
      white-space: nowrap;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .contextual-help:hover .help-tooltip {
      opacity: 1;
      transform: translateY(0);
    }

    /* Progressive Disclosure */
    .expandable-section {
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .expandable-section.collapsed {
      max-height: 0;
    }

    .expand-trigger {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #667eea;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .expand-trigger:hover {
      color: #5a67d8;
    }

    .expand-trigger .icon {
      transition: transform 0.3s ease;
    }

    .expand-trigger.expanded .icon {
      transform: rotate(180deg);
    }

    /* Intelligent Form Validation */
    .validation-message {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.8rem;
      color: #e53e3e;
      margin-top: 4px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 10;
    }

    .validation-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .validation-message.success {
      background: #f0fff4;
      border-color: #9ae6b4;
      color: #38a169;
    }

    /* Smart Keyboard Navigation */
    .keyboard-shortcut {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-family: monospace;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .btn:hover .keyboard-shortcut,
    .form-group:hover .keyboard-shortcut {
      opacity: 1;
    }

    /* Enhanced Loading States */
    .content-skeleton {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
    }

    .skeleton-line {
      height: 12px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    .skeleton-line.wide { width: 100%; }
    .skeleton-line.medium { width: 75%; }
    .skeleton-line.narrow { width: 50%; }

    /* Smart Onboarding */
    .onboarding-highlight {
      position: relative;
      z-index: 1001;
    }

    .onboarding-highlight::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      animation: pulse 2s ease-in-out infinite;
      z-index: -1;
    }

    .onboarding-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .onboarding-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Optimistic UI Updates */
    .optimistic-update {
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
      animation: optimisticPulse 2s ease-in-out;
    }

    @keyframes optimisticPulse {
      0%, 100% { background: rgba(102, 126, 234, 0.1); }
      50% { background: rgba(102, 126, 234, 0.2); }
    }

    /* Enhanced Responsive Interactions */
    @media (max-width: 768px) {
      .notification-toast {
        right: 10px;
        left: 10px;
        max-width: none;
        transform: translateY(-100%);
      }

      .notification-toast.show {
        transform: translateY(0);
      }

      .contextual-help {
        width: 50px;
        height: 50px;
        font-size: 20px;
        bottom: 20px;
        right: 20px;
      }
    }

    /* Voice Command Indicators */
    .voice-indicator {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #e53e3e;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .voice-indicator.active {
      opacity: 1;
      animation: voicePulse 1s ease-in-out infinite;
    }

    @keyframes voicePulse {
      0%, 100% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.2); }
    }

    /* Smart Data Persistence Indicators */
    .data-sync-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid rgba(225, 232, 237, 0.6);
      font-size: 0.8rem;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s ease;
    }

    .data-sync-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .sync-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #38a169;
    }

    .sync-status-dot.syncing {
      background: #667eea;
      animation: pulse 1s ease-in-out infinite;
    }

    .sync-status-dot.error {
      background: #e53e3e;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <span>🐾</span>
                            <span>PetPulse</span>
      </div>
      <div style="display: flex; align-items: center;">
        <div class="nav-menu">
          <div class="nav-item" onclick="showSection('add-pet')">
            <i class="fas fa-plus"></i>
            <span>Add a Pet</span>
          </div>
          <div class="nav-item active" onclick="showSection('assistant')">
            <i class="fas fa-robot"></i>
            <span>Pet Health Assistant</span>
          </div>
          <div class="nav-item" onclick="showSection('recording')">
            <i class="fas fa-microphone"></i>
            <span>Voice Recording</span>
          </div>
          <div class="nav-item" onclick="showSection('notes')">
            <i class="fas fa-file-alt"></i>
            <span>Notes & Files</span>
          </div>
          <div class="nav-item" onclick="showSection('tracking')">
            <i class="fas fa-clipboard-list"></i>
            <span>Tracking</span>
          </div>
          <div class="nav-item" onclick="showSection('analytics')">
            <i class="fas fa-chart-line"></i>
            <span>Analytics</span>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Simplified Pet Selection (Common for all pages except Add a Pet) -->
    <div class="card" id="pet-selector-card">        <div class="section-title">
          <i class="fas fa-paw"></i>
          Select Your Pet
          <span class="status-indicator online" id="pet-status">
            <i class="fas fa-circle"></i>
            Ready
          </span>
        </div>
        <div class="select-wrapper">
          <select id="pet-select" aria-label="Select your pet"></select>
          <div class="form-error" id="pet-select-error"></div>
        </div>
    </div>

    <!-- Add a Pet Section -->
    <div id="add-pet-section" class="section">
      <div class="section-header">
        <h1>🐾 Add a Pet</h1>
        <p>Create a new pet profile with complete breed and animal information</p>
      </div>

      <div class="card">
        <div class="section-title">
          <i class="fas fa-plus-circle"></i>
          Pet Information
        </div>
        <form id="add-pet-form" role="form" aria-label="Add new pet">
          <div class="progress-bar">
            <div class="progress-fill" id="form-progress"></div>
          </div>
          
          <div class="form-group">
            <label for="pet-name">Pet Name *</label>
            <input 
              type="text" 
              id="pet-name" 
              placeholder=" " 
              required 
              aria-describedby="pet-name-error"
              data-tooltip="Enter your pet's full name"
              class="tooltip"
            />
            <span class="floating-label">Enter your pet's name</span>
            <div class="form-error" id="pet-name-error"></div>
          </div>
          
          <div class="form-group">
            <label for="animal-type">Animal Type *</label>
            <select id="animal-type" required aria-describedby="animal-type-error">
              <option value="">Select animal type</option>
              <option value="dog">🐕 Dog</option>
              <option value="cat">🐱 Cat</option>
              <option value="bird">🐦 Bird</option>
              <option value="rabbit">🐰 Rabbit</option>
              <option value="hamster">🐹 Hamster</option>
              <option value="guinea-pig">🐹 Guinea Pig</option>
              <option value="fish">🐠 Fish</option>
              <option value="reptile">🦎 Reptile</option>
              <option value="other">🐾 Other</option>
            </select>
            <div class="form-error" id="animal-type-error"></div>
          </div>
          
          <div class="form-group">
            <label for="pet-breed">Breed</label>
            <input 
              type="text" 
              id="pet-breed" 
              placeholder=" " 
              aria-describedby="pet-breed-help"
              data-tooltip="Specific breed or mix helps us provide better health recommendations"
              class="tooltip"
            />
            <span class="floating-label">Enter breed (e.g., Golden Retriever, Persian, etc.)</span>
            <small id="pet-breed-help" style="color: #7f8c8d; font-size: 0.9rem;">
              This helps us provide breed-specific health recommendations
            </small>
          </div>
          
          <div class="form-group">
            <label for="pet-age">Age (optional)</label>
            <input 
              type="number" 
              id="pet-age" 
              placeholder=" " 
              min="0" 
              max="30" 
              step="0.1"
              aria-describedby="pet-age-error"
              data-tooltip="Age helps us provide age-appropriate care recommendations"
              class="tooltip"
            />
            <span class="floating-label">Age in years</span>
            <div class="form-error" id="pet-age-error"></div>
          </div>
          
          <div class="form-group">
            <label for="pet-weight">Weight (optional)</label>
            <input 
              type="number" 
              id="pet-weight" 
              placeholder=" " 
              min="0" 
              step="0.1"
              aria-describedby="pet-weight-error"
              data-tooltip="Current weight helps monitor health trends"
              class="tooltip"
            />
            <span class="floating-label">Weight in lbs</span>
            <div class="form-error" id="pet-weight-error"></div>
          </div>
          
          <div class="form-group">
            <label for="pet-gender">Gender (optional)</label>
            <select id="pet-gender" aria-describedby="pet-gender-error">
              <option value="">Select gender</option>
              <option value="male">♂️ Male</option>
              <option value="female">♀️ Female</option>
              <option value="male-neutered">♂️ Male (Neutered)</option>
              <option value="female-spayed">♀️ Female (Spayed)</option>
            </select>
            <div class="form-error" id="pet-gender-error"></div>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="create-pet-btn">
            <i class="fas fa-plus"></i>
            Create Pet Profile
          </button>
        </form>
        
        <div id="add-pet-status" class="status-message"></div>
      </div>
    </div>

    <!-- AI Assistant Section -->
    <div id="assistant-section" class="section active">
      <div class="section-header">
        <h1>🤖 Pet Health Assistant</h1>
        <p>Chat with your AI assistant for personalized health advice based on your pet's complete health history</p>
      </div>

      <!-- Chat Interface -->
      <div class="card" style="
        background: white; 
        border-radius: 20px; 
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1); 
        padding: 40px; 
        margin-bottom: 40px; 
        border: 2px solid rgba(102, 126, 234, 0.1);
        position: relative;
        overflow: hidden;
      ">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
        <div class="section-title" style="font-size: 1.5rem; margin-bottom: 25px;">
          <i class="fas fa-comments"></i>
          Chat with AI Assistant
        </div>
        
        <!-- Chat Messages Container -->
        <div id="chat-container" style="
          height: 1000px;
          border: 2px solid rgba(225, 232, 237, 0.6);
          border-radius: 24px;
          overflow-y: auto;
          padding: 30px;
          background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(255, 255, 255, 0.9));
          backdrop-filter: blur(20px);
          margin-bottom: 25px;
          display: flex;
          flex-direction: column;
          gap: 20px;
          box-shadow: inset 0 4px 16px rgba(0, 0, 0, 0.05),
                      0 4px 16px rgba(102, 126, 234, 0.1);
          position: relative;
          overflow-x: hidden;
        ">
          <div class="assistant-message">
            <div style="display: flex; align-items: flex-start; gap: 16px;">
              <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea, #764ba2, #4ecdc4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; flex-shrink: 0; box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4); animation: float 3s ease-in-out infinite;">
                🤖
              </div>
              <div style="background: rgba(255, 255, 255, 0.95); padding: 24px; border-radius: 20px; border: 1px solid rgba(225, 232, 237, 0.6); flex: 1; line-height: 1.7; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08); backdrop-filter: blur(10px); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2, #4ecdc4); opacity: 0.7;"></div>
                <strong style="color: #667eea; font-size: 1.2rem; background: linear-gradient(135deg, #667eea, #764ba2); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Hello! I'm your Pet Health Assistant.</strong><br><br>
                I have access to all your pet's health data including:
                <ul style="margin: 16px 0; padding-left: 24px; color: #4a5568; line-height: 1.6;">
                  <li style="margin: 8px 0;">📝 Voice notes and text entries</li>
                  <li style="margin: 8px 0;">🏥 Medical records from PDFs</li>
                  <li style="margin: 8px 0;">📊 Health tracking data</li>
                  <li style="margin: 8px 0;">🩺 Veterinary knowledge base</li>
                </ul>
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(78, 205, 196, 0.1)); padding: 18px; border-radius: 16px; margin-top: 16px; border: 1px solid rgba(102, 126, 234, 0.2);">
                  <strong style="color: #667eea; background: linear-gradient(135deg, #667eea, #764ba2); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Ask me questions like:</strong>
                  <br><em style="color: #4a5568; font-style: italic;">"How has my pet's energy been lately?" or "What patterns do you see in their health data?"</em>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Chat Input with Smart UX -->
        <div style="display: flex; gap: 15px; align-items: flex-end;">
          <div style="flex: 1; position: relative;">
            <textarea 
              id="chat-input" 
              class="search-input"
              placeholder="Ask me about your pet's health, symptoms, patterns, or get recommendations..."
              style="min-height: 100px; resize: vertical; width: 100%; font-size: 1rem; line-height: 1.5; padding: 16px; border-radius: 12px; border: 2px solid #e1e8ed; transition: all 0.3s ease;"
              aria-label="Chat with AI assistant"
              maxlength="1000"
            ></textarea>
            <div style="font-size: 0.75rem; color: #7f8c8d; text-align: right; margin-top: 4px; display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #667eea; font-weight: 500;">💡 Try: "Is my dog's weight normal?" or "What vaccines does my cat need?"</span>
              <span id="char-count">0</span>/1000 characters
            </div>
          </div>
          <button 
            id="send-chat" 
            class="btn btn-primary" 
            onclick="sendChatMessage()"
            style="height: fit-content; white-space: nowrap; padding: 16px 24px; font-size: 1rem; font-weight: 600; position: relative;"
            aria-label="Send message to AI assistant"
          >
            <span class="keyboard-shortcut">Enter</span>
            <i class="fas fa-paper-plane"></i>
            Ask Assistant
          </button>
        </div>
        
        <!-- Quick Questions -->
        <div style="margin-top: 20px;">
          <div style="font-weight: 600; margin-bottom: 15px; color: #667eea; font-size: 1.1rem;">
            <i class="fas fa-bolt"></i> Quick Questions:
          </div>
          <div id="quick-questions-container" style="display: flex; flex-wrap: wrap; gap: 12px;">
            <div id="quick-questions-loading" style="color: #7f8c8d; font-style: italic;">
              <i class="fas fa-spinner fa-spin"></i> Loading quick questions...
            </div>
            <div id="quick-questions-buttons" style="display: none;">
              <div style="display: flex; flex-wrap: wrap; gap: 12px; width: 100%;">
                <button class="quick-question-btn" onclick="askQuickQuestion('How has my pet been feeling lately?')">
                  <i class="fas fa-heart"></i> Recent Health Summary
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('What patterns do you see in my pet\'s behavior?')">
                  <i class="fas fa-chart-line"></i> Behavior Patterns
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('Any health concerns I should be aware of?')">
                  <i class="fas fa-exclamation-triangle"></i> Health Alerts
                </button>
                <button class="quick-question-btn" onclick="askQuickQuestion('Generate a health report for my vet visit')">
                  <i class="fas fa-file-medical"></i> Vet Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Health Insights Section -->
      <div style="margin-bottom: 40px;">
        <div class="section-header" style="margin-bottom: 30px; padding: 30px 25px;">
          <h2 style="color: #667eea; font-size: 2rem; margin-bottom: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4ecdc4 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);">🔍 Health Insights</h2>
          <p style="color: #4a5568; font-size: 1.1rem; font-weight: 500; text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);">Search our knowledge base and get AI-powered insights from your pet's health data</p>
        </div>

        <!-- Knowledge Search -->
        <div class="card" style="margin-bottom: 30px;">
          <div class="section-title">
            <i class="fas fa-search"></i>
            Search Pet Health Knowledge
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <input 
              type="text" 
              id="knowledge-search" 
              placeholder="Search symptoms, treatments, conditions..."
              style="flex: 1;"
            />
            <button class="btn btn-secondary" onclick="searchKnowledge()">
              <i class="fas fa-search"></i>
              Search
            </button>
          </div>
          
          <div id="knowledge-results" style="min-height: 100px; background: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e1e8ed;">
            <div style="text-align: center; color: #7f8c8d;">
              <i class="fas fa-book-medical"></i>
              <p>Search our veterinary knowledge base for symptoms, treatments, and health information</p>
            </div>
          </div>
        </div>

        <!-- Health Analytics Summary -->
        <div class="card">
          <div class="section-title">
            <i class="fas fa-chart-pie"></i>
            AI Health Insights
          </div>
          
          <div id="ai-health-summary" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 2.5rem; margin-bottom: 10px;">🤖</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">AI Health Insights</div>
              <div style="opacity: 0.9;">Ask a question below or use the chat to get personalized health insights based on your pet's data</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice Recording Section -->
    <div id="recording-section" class="section">
      <div class="section-header">
        <h1>Voice Recording</h1>
        <p>Record voice notes about your pet's health, daily activities, or general observations</p>
      </div>

      <div class="card">
        <div class="section-title">
          <i class="fas fa-microphone"></i>
          Smart Voice Recording
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
          <h4 style="margin: 0 0 10px 0; color: #667eea;">
            <i class="fas fa-info-circle"></i> What can you record?
          </h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <strong>🏥 Medical & Health:</strong>
              <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                <li>Symptoms & health concerns</li>
                <li>Vet visit notes & treatments</li>
                <li>Medication schedules</li>
                <li>Behavioral health changes</li>
                <li>Pain or discomfort signs</li>
              </ul>
            </div>
            <div>
              <strong>🎾 Daily Life & Activities:</strong>
              <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                <li>Exercise & playtime details</li>
                <li>Meals, treats & appetite</li>
                <li>Sleep patterns & quality</li>
                <li>Training progress & wins</li>
                <li>Mood, energy & social time</li>
                <li>Grooming & hygiene care</li>
                <li>Special moments & achievements</li>
              </ul>
            </div>
          </div>
          <div style="margin-top: 10px; padding: 8px; background: #e8f4fd; border-radius: 5px;">
            <small style="color: #1e40af; font-weight: 500;">
              <i class="fas fa-brain"></i> 
              <strong>AI-Powered:</strong> Our smart assistant automatically detects whether you're sharing medical concerns or celebrating daily activities, then provides the perfect summary with the right tone!
            </small>
          </div>
        </div>
        
        <button id="record-button" class="btn btn-primary record-button" onclick="toggleRecording()" aria-label="Start or stop voice recording">
          <i class="fas fa-microphone"></i>
          <span id="record-button-text">Start Recording</span>
        </button>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <div id="output" class="output">
          <div class="transcript">
            <h3><i class="fas fa-quote-left"></i> Transcript</h3>
            <div id="transcript-content"></div>
          </div>
          <div class="summary">
            <h3><i class="fas fa-brain"></i> AI Analysis</h3>
            <div id="content-type-badge" style="display: none; margin-bottom: 10px;"></div>
            <div id="summary-content"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes & Files Section -->
    <div id="notes-section" class="section">
      <div class="section-header">
        <h1>Notes & Files</h1>
        <p>Manage pet health records, notes, and medical documents</p>
      </div>

      <div class="grid">
        <div class="card">
          <div class="section-title">
            <i class="fas fa-sticky-note"></i>
            Shared Page Notes
          </div>
          <div class="form-group">
            <textarea id="markdown-input" placeholder="Write shared notes for all pets on this page..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveMarkdown()">
            <i class="fas fa-save"></i>
            Save Page Notes
          </button>
          <div id="markdown-status" class="status-message"></div>
        </div>

        <div class="card">
          <div class="section-title">
            <i class="fas fa-edit"></i>
            Smart Pet Notes
          </div>
          <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
            <h4 style="margin: 0 0 10px 0; color: #667eea;">
              <i class="fas fa-info-circle"></i> What can you write about?
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <strong>🏥 Medical & Health:</strong>
                <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                  <li>Symptoms & health concerns</li>
                  <li>Vet visit notes & treatments</li>
                  <li>Medication schedules</li>
                  <li>Behavioral health changes</li>
                  <li>Pain or discomfort signs</li>
                </ul>
              </div>
              <div>
                <strong>🎾 Daily Life & Activities:</strong>
                <ul style="margin: 5px 0; padding-left: 20px; color: #666;">
                  <li>Exercise & playtime details</li>
                  <li>Meals, treats & appetite</li>
                  <li>Sleep patterns & quality</li>
                  <li>Training progress & wins</li>
                  <li>Mood, energy & social time</li>
                  <li>Grooming & hygiene care</li>
                  <li>Special moments & achievements</li>
                </ul>
              </div>
            </div>
          </div>
          <div style="margin-bottom: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
            <small style="color: #1e40af; font-weight: 500;">
              <i class="fas fa-brain"></i> 
              <strong>AI-Powered:</strong> Our smart assistant automatically detects whether you're sharing medical concerns or celebrating daily activities, then provides the perfect summary with the right tone!
            </small>
          </div>
          <div class="form-group">
            <label for="pet-input-text" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
              Share what's happening with your pet:
            </label>
            <textarea 
              id="pet-input-text" 
              placeholder="Share anything about your pet... 

Examples:
• Medical: 'Noticed limping on back leg after walk, seems to favor it when walking'
• Daily: 'Amazing 45-minute hike today! So much energy and perfect leash behavior'
• Training: 'Finally mastered sit-stay command for 30 seconds with treats!'
• Social: 'Had great playdate at dog park, very social with new friends'
• Routine: 'Perfect morning - ate breakfast eagerly, energetic walk, now napping in sunny spot'
• Mixed: 'Great walk but noticed heavier breathing than usual during exercise'

The AI will automatically detect the content type and provide the perfect summary!"
              style="width: 100%; min-height: 150px; padding: 20px; border: 2px solid #e1e8ed; border-radius: 12px; font-size: 1rem; line-height: 1.6; resize: vertical;"
              maxlength="2000"
              aria-describedby="text-input-help"
            ></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
              <small id="text-input-help" style="color: #7f8c8d; font-size: 0.9rem;">
                <i class="fas fa-brain"></i> AI will automatically categorize and summarize your input
              </small>
              <span style="font-size: 0.75rem; color: #7f8c8d;">
                <span id="text-char-count">0</span>/2000 characters
              </span>
            </div>
          </div>
          <button class="btn btn-success" onclick="submitPetText()" id="submit-note-btn" aria-label="Submit pet note for AI processing">
            <i class="fas fa-plus"></i>
            Add Smart Note
          </button>
          <div id="pet-input-status" class="status-message"></div>
          
          <!-- Results Display -->
          <div id="pet-text-output" class="output">
            <div class="transcript">
              <h3><i class="fas fa-quote-left"></i> Your Note</h3>
              <div id="pet-text-content"></div>
            </div>
            <div class="summary">
              <h3><i class="fas fa-brain"></i> AI Analysis</h3>
              <div id="pet-text-type-badge" style="display: none; margin-bottom: 10px;"></div>
              <div id="pet-text-summary"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <i class="fas fa-file-medical"></i>
          Upload Medical Documents
        </div>
        <form id="pdf-form">
          <div class="file-upload" onclick="document.getElementById('pdf-file').click()">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="upload-text">
              <strong>Click to upload</strong> or drag and drop<br>
              PDF files only
            </div>
            <input type="file" id="pdf-file" accept="application/pdf" required />
          </div>
          <button type="submit" class="btn btn-primary" style="margin-top: 20px; width: 100%;">
            <i class="fas fa-upload"></i>
            Upload and Analyze Document
          </button>
        </form>
        <div id="pdf-result" class="result-box"></div>
      </div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics-section" class="section">
      <div class="section-header">
        <h1>Analytics</h1>
        <p>Comprehensive health insights and visualizations for your pet</p>
      </div>

      <!-- Daily Routine Headlines -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-star"></i>
          Today's Highlights
        </div>
        <div id="daily-headlines" style="min-height: 60px; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; color: white; margin-bottom: 20px;">
          <div style="text-align: center; color: rgba(255,255,255,0.8);">
            <i class="fas fa-clock"></i> Loading today's highlights...
          </div>
        </div>
        <button onclick="generateDailyHeadlines()" class="btn btn-secondary">
          <i class="fas fa-magic"></i>
          Generate AI Headlines
        </button>
      </div>

      <!-- Dashboard Summary -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-chart-line"></i>
          Health Dashboard
        </div>

        <div id="dashboard-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px;">
          <div class="metric-card" data-category="diet">
            <div class="metric-icon">🍽️</div>
            <div class="metric-label">Diet Entries</div>
            <div class="metric-value">0</div>
          </div>
          <div class="metric-card" data-category="exercise">
            <div class="metric-icon">🏃</div>
            <div class="metric-label">Exercise Sessions</div>
            <div class="metric-value">0</div>
          </div>
          <div class="metric-card" data-category="medication">
            <div class="metric-icon">💊</div>
            <div class="metric-label">Medications</div>
            <div class="metric-value">0</div>
          </div>
          <div class="metric-card" data-category="daily_activity">
            <div class="metric-icon">📝</div>
            <div class="metric-label">Daily Activities</div>
            <div class="metric-value">0</div>
          </div>
          <div class="metric-card" data-category="medical_notes">
            <div class="metric-icon">🏥</div>
            <div class="metric-label">Medical Notes</div>
            <div class="metric-value">0</div>
          </div>
          <div class="metric-card" data-category="energy_levels">
            <div class="metric-icon">⚡</div>
            <div class="metric-label">Avg Energy</div>
            <div class="metric-value">0</div>
          </div>
        </div>

        <!-- Charts Container -->
        <div id="charts-container" style="margin-top: 30px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="chart-container">
              <h4>Weekly Activity Trend</h4>
              <canvas id="activityChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Energy Levels Distribution</h4>
              <canvas id="energyChart" width="400" height="200"></canvas>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="chart-container">
              <h4>Diet Frequency</h4>
              <canvas id="dietChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Health Metrics Overview</h4>
              <canvas id="overviewChart" width="400" height="200"></canvas>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="chart-container">
              <h4>Exercise Duration Distribution</h4>
              <canvas id="exerciseHistogram" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
              <h4>Medication Adherence</h4>
              <canvas id="medicationChart" width="400" height="200"></canvas>
            </div>
          </div>
          <!-- Activity Heatmap -->
          <div class="chart-container" style="margin-bottom: 20px;">
            <h4>Daily Activity Heatmap</h4>
            <div id="activityHeatmap" style="height: 100px; background: #f8fafc; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 2px;">
              <!-- Will be populated with hourly activity blocks -->
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #7f8c8d; margin-top: 5px;">
              <span>12 AM</span>
              <span>6 AM</span>
              <span>12 PM</span>
              <span>6 PM</span>
              <span>11 PM</span>
            </div>
          </div>
        </div>
      </div>


    </div>

    <!-- Tracking Section -->
    <div id="tracking-section" class="section">
      <div class="section-header">
        <h1>Tracking</h1>
        <p>Track daily activities, health data, and monitor your pet's well-being</p>
      </div>

      <!-- Data Entry Tabs -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-plus-circle"></i>
          Track Health Data
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 8px; margin-bottom: 30px; border-bottom: 2px solid #f1f3f4; padding-bottom: 10px; flex-wrap: wrap;">
          <button class="tab-btn active" onclick="showTab('diet')">
            <i class="fas fa-utensils"></i> Diet & Nutrition
          </button>
          <button class="tab-btn" onclick="showTab('exercise')">
            <i class="fas fa-running"></i> Exercise
          </button>
          <button class="tab-btn" onclick="showTab('medication')">
            <i class="fas fa-pills"></i> Medication
          </button>
          <button class="tab-btn" onclick="showTab('grooming')">
            <i class="fas fa-cut"></i> Grooming
          </button>
          <button class="tab-btn" onclick="showTab('monitoring')">
            <i class="fas fa-heartbeat"></i> Monitoring
          </button>
          <button class="tab-btn" onclick="showTab('weight')">
            <i class="fas fa-weight"></i> Weight
          </button>
          <button class="tab-btn" onclick="showTab('sleep')">
            <i class="fas fa-bed"></i> Sleep
          </button>
          <button class="tab-btn" onclick="showTab('mood')">
            <i class="fas fa-smile"></i> Mood
          </button>
        </div>

        <!-- Diet & Nutrition Tab -->
        <div id="diet-tab" class="tab-content active">
          <form id="diet-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="diet-food">Food/Treat</label>
                <input type="text" id="diet-food" placeholder="e.g., Chicken breast, Dog treats" required />
              </div>
              <div class="form-group">
                <label for="diet-quantity">Quantity</label>
                <input type="text" id="diet-quantity" placeholder="e.g., 1 cup, 50g" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="diet-time">Time</label>
                <input type="time" id="diet-time" />
              </div>
              <div class="form-group">
                <label for="diet-type">Meal Type</label>
                <select id="diet-type">
                  <option value="breakfast">Breakfast</option>
                  <option value="lunch">Lunch</option>
                  <option value="dinner">Dinner</option>
                  <option value="treat">Treat/Snack</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="diet-notes">Notes</label>
              <textarea id="diet-notes" placeholder="Any special notes about this meal..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Add Diet Entry
            </button>
          </form>
        </div>

        <!-- Exercise Tab -->
        <div id="exercise-tab" class="tab-content">
          <form id="exercise-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="exercise-type">Exercise Type</label>
                <select id="exercise-type">
                  <option value="walk">Walk</option>
                  <option value="run">Run</option>
                  <option value="play">Play</option>
                  <option value="fetch">Fetch</option>
                  <option value="swimming">Swimming</option>
                  <option value="training">Training</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="exercise-duration">Duration (minutes)</label>
                <input type="number" id="exercise-duration" min="1" max="300" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="exercise-intensity">Intensity</label>
                <select id="exercise-intensity">
                  <option value="low">Low</option>
                  <option value="moderate">Moderate</option>
                  <option value="high">High</option>
                </select>
              </div>
              <div class="form-group">
                <label for="exercise-location">Location</label>
                <input type="text" id="exercise-location" placeholder="e.g., Park, Backyard" />
              </div>
            </div>
            <div class="form-group">
              <label for="exercise-notes">Notes</label>
              <textarea id="exercise-notes" placeholder="How did your pet enjoy this exercise?"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Add Exercise Entry
            </button>
          </form>
        </div>

        <!-- Medication Tab -->
        <div id="medication-tab" class="tab-content">
          <form id="medication-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="medication-name">Medication Name</label>
                <input type="text" id="medication-name" placeholder="e.g., Rimadyl, Heartgard" required />
              </div>
              <div class="form-group">
                <label for="medication-dosage">Dosage</label>
                <input type="text" id="medication-dosage" placeholder="e.g., 50mg, 1 tablet" required />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="medication-time">Time Given</label>
                <input type="time" id="medication-time" />
              </div>
              <div class="form-group">
                <label for="medication-frequency">Frequency</label>
                <select id="medication-frequency">
                  <option value="once">Once daily</option>
                  <option value="twice">Twice daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="as-needed">As needed</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="medication-purpose">Purpose</label>
              <input type="text" id="medication-purpose" placeholder="e.g., Pain relief, Heartworm prevention" />
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Add Medication Entry
            </button>
          </form>
        </div>

        <!-- Grooming Tab -->
        <div id="grooming-tab" class="tab-content">
          <form id="grooming-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="grooming-type">Grooming Type</label>
                <select id="grooming-type" multiple>
                  <option value="bath">Bath</option>
                  <option value="brushing">Brushing</option>
                  <option value="nail-trim">Nail Trimming</option>
                  <option value="ear-cleaning">Ear Cleaning</option>
                  <option value="teeth-brushing">Teeth Brushing</option>
                  <option value="professional">Professional Grooming</option>
                </select>
              </div>
              <div class="form-group">
                <label for="grooming-duration">Duration (minutes)</label>
                <input type="number" id="grooming-duration" min="1" max="180" />
              </div>
            </div>
            <div class="form-group">
              <label for="grooming-products">Products Used</label>
              <input type="text" id="grooming-products" placeholder="e.g., Oatmeal shampoo, Nail clippers" />
            </div>
            <div class="form-group">
              <label for="grooming-notes">Notes</label>
              <textarea id="grooming-notes" placeholder="How did your pet behave? Any issues?"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Add Grooming Entry
            </button>
          </form>
        </div>

        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Energy Levels -->
            <form id="energy-form" class="analytics-form">
              <h4><i class="fas fa-bolt"></i> Energy Level</h4>
              <div class="form-group">
                <label for="energy-level">Energy Level (1-5)</label>
                <div class="energy-selector">
                  <input type="range" id="energy-level" min="1" max="5" value="3" />
                  <div class="energy-labels">
                    <span>Very Low</span>
                    <span>Low</span>
                    <span>Normal</span>
                    <span>High</span>
                    <span>Very High</span>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="energy-notes">Notes</label>
                <textarea id="energy-notes" placeholder="Describe your pet's energy level..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Log Energy
              </button>
            </form>

            <!-- Bowel Movements -->
            <form id="bowel-form" class="analytics-form">
              <h4><i class="fas fa-poop"></i> Bowel Movement</h4>
              <div class="form-group">
                <label for="bowel-consistency">Consistency</label>
                <select id="bowel-consistency">
                  <option value="normal">Normal</option>
                  <option value="soft">Soft</option>
                  <option value="loose">Loose</option>
                  <option value="hard">Hard</option>
                  <option value="liquid">Liquid</option>
                </select>
              </div>
              <div class="form-group">
                <label for="bowel-time">Time</label>
                <input type="time" id="bowel-time" />
              </div>
              <div class="form-group">
                <label for="bowel-notes">Notes</label>
                <textarea id="bowel-notes" placeholder="Any unusual observations..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Log Movement
              </button>
            </form>
          </div>

          <!-- Exit Events -->
          <form id="exit-form" class="analytics-form" style="margin-top: 20px;">
            <h4><i class="fas fa-door-open"></i> Exit Event</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="exit-type">Event Type</label>
                <select id="exit-type">
                  <option value="walk">Walk</option>
                  <option value="potty">Potty Break</option>
                  <option value="play">Outdoor Play</option>
                  <option value="car-ride">Car Ride</option>
                  <option value="vet-visit">Vet Visit</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="exit-duration">Duration (minutes)</label>
                <input type="number" id="exit-duration" min="1" />
              </div>
            </div>
            <div class="form-group">
              <label for="exit-destination">Destination</label>
              <input type="text" id="exit-destination" placeholder="e.g., Dog park, Vet clinic" />
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Log Exit Event
            </button>
          </form>
        </div>

        <!-- Weight Tracking Tab -->
        <div id="weight-tab" class="tab-content">
          <form id="weight-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="weight-value">Weight</label>
                <input type="number" id="weight-value" step="0.1" min="0" placeholder="e.g., 25.5" required />
              </div>
              <div class="form-group">
                <label for="weight-unit">Unit</label>
                <select id="weight-unit">
                  <option value="lbs">Pounds (lbs)</option>
                  <option value="kg">Kilograms (kg)</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="weight-method">Measurement Method</label>
                <select id="weight-method">
                  <option value="home-scale">Home Scale</option>
                  <option value="vet-visit">Vet Visit</option>
                  <option value="groomer">At Groomer</option>
                </select>
              </div>
              <div class="form-group">
                <label for="weight-time">Time</label>
                <input type="time" id="weight-time" />
              </div>
            </div>
            <div class="form-group">
              <label for="weight-notes">Notes</label>
              <textarea id="weight-notes" placeholder="Any observations about weight change..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Record Weight
            </button>
          </form>
        </div>

        <!-- Sleep Tracking Tab -->
        <div id="sleep-tab" class="tab-content">
          <form id="sleep-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="sleep-duration">Sleep Duration (hours)</label>
                <input type="number" id="sleep-duration" step="0.5" min="0" max="24" placeholder="e.g., 8.5" />
              </div>
              <div class="form-group">
                <label for="sleep-quality">Sleep Quality</label>
                <select id="sleep-quality">
                  <option value="excellent">Excellent</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                  <option value="poor">Poor</option>
                  <option value="restless">Restless</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="sleep-location">Sleep Location</label>
                <input type="text" id="sleep-location" placeholder="e.g., Dog bed, Couch, Owner's bed" />
              </div>
              <div class="form-group">
                <label for="sleep-interruptions">Interruptions</label>
                <input type="number" id="sleep-interruptions" min="0" placeholder="Number of times woken up" />
              </div>
            </div>
            <div class="form-group">
              <label for="sleep-notes">Notes</label>
              <textarea id="sleep-notes" placeholder="Sleep behavior observations..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Log Sleep
            </button>
          </form>
        </div>

        <!-- Mood Tracking Tab -->
        <div id="mood-tab" class="tab-content">
          <form id="mood-form" class="analytics-form">
            <div class="form-row">
              <div class="form-group">
                <label for="mood-level">Overall Mood (1-5)</label>
                <div class="mood-selector">
                  <input type="range" id="mood-level" min="1" max="5" value="3" />
                  <div class="mood-labels">
                    <span>😢 Sad</span>
                    <span>😟 Low</span>
                    <span>😐 Neutral</span>
                    <span>😊 Happy</span>
                    <span>🤩 Excited</span>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="mood-triggers">Mood Triggers</label>
                <select id="mood-triggers" multiple>
                  <option value="food">Food/Treats</option>
                  <option value="exercise">Exercise</option>
                  <option value="visitors">Visitors</option>
                  <option value="weather">Weather</option>
                  <option value="other-pets">Other Pets</option>
                  <option value="loud-noises">Loud Noises</option>
                  <option value="car-ride">Car Ride</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="mood-behavior">Observed Behavior</label>
                <select id="mood-behavior" multiple>
                  <option value="playful">Playful</option>
                  <option value="lethargic">Lethargic</option>
                  <option value="anxious">Anxious</option>
                  <option value="aggressive">Aggressive</option>
                  <option value="affectionate">Affectionate</option>
                  <option value="withdrawn">Withdrawn</option>
                  <option value="hyperactive">Hyperactive</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mood-time">Time Observed</label>
                <input type="time" id="mood-time" />
              </div>
            </div>
            <div class="form-group">
              <label for="mood-notes">Detailed Notes</label>
              <textarea id="mood-notes" placeholder="Describe your pet's mood and behavior in detail..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              Record Mood
            </button>
          </form>
        </div>
      </div>

      <!-- Recent Entries -->
      <div class="card">
        <div class="section-title">
          <i class="fas fa-history"></i>
          Recent Entries
        </div>
        <div id="recent-entries" style="min-height: 100px;">
          <div style="text-align: center; color: #7f8c8d; padding: 40px;">
            <i class="fas fa-clock"></i>
            <p>No recent entries. Start tracking your pet's activities above!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
  ">
    <div style="text-align: center;">
      <div style="
        width: 50px;
        height: 50px;
        border: 4px solid #e1e8ed;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <p style="color: #667eea; font-weight: 500;">Loading...</p>
    </div>
  </div>

  <script type="module">
    import { app } from "./firebase-config.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const auth = getAuth(app);
    const pageId = "default-page";
    let currentUser = null;
    let selectedPet = "";
    let isRecording = false;
    let assistantDataLoaded = false; // Track if assistant data has been loaded

    // Navigation functionality
    window.showSection = function(sectionName) {
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Find and activate the correct nav item
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        if ((sectionName === 'add-pet' && item.textContent.includes('Add a Pet')) ||
            (sectionName === 'assistant' && item.textContent.includes('Pet Health Assistant')) ||
            (sectionName === 'recording' && item.textContent.includes('Voice Recording')) ||
            (sectionName === 'notes' && item.textContent.includes('Notes & Files')) ||
            (sectionName === 'analytics' && item.textContent.includes('Analytics')) ||
            (sectionName === 'tracking' && item.textContent.includes('Tracking'))) {
          item.classList.add('active');
        }
      });

      // Show/hide pet selector card based on section
      const petSelectorCard = document.getElementById('pet-selector-card');
      if (sectionName === 'add-pet') {
        petSelectorCard.style.display = 'none';
      } else {
        petSelectorCard.style.display = 'block';
      }

      // Update sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });

      if (sectionName === 'add-pet') {
        document.getElementById('add-pet-section').classList.add('active');
        window.location.hash = 'add-pet';
      } else if (sectionName === 'recording') {
        document.getElementById('recording-section').classList.add('active');
        window.location.hash = 'recording';
      } else if (sectionName === 'notes') {
        document.getElementById('notes-section').classList.add('active');
        loadMarkdown(); // Load notes when switching to notes section
        window.location.hash = 'notes';
      } else if (sectionName === 'analytics') {
        document.getElementById('analytics-section').classList.add('active');
        loadDashboard(); // Load dashboard when switching to analytics
        updateCharts(); // Update charts when switching to analytics
        generateDailyHeadlines(); // Generate today's headlines
        window.location.hash = 'analytics';
      } else if (sectionName === 'tracking') {
        document.getElementById('tracking-section').classList.add('active');
        loadRecentEntries(); // Load recent entries for tracking
        window.location.hash = 'tracking';
      } else if (sectionName === 'assistant') {
        document.getElementById('assistant-section').classList.add('active');
        // Don't load assistant data automatically - only when user interacts
        window.location.hash = 'assistant';
      }
    };

    // Handle URL hash navigation
    function handleHashNavigation() {
      const hash = window.location.hash.substring(1);
      if (hash === 'add-pet') {
        showSection('add-pet');
      } else if (hash === 'notes') {
        showSection('notes');
      } else if (hash === 'analytics') {
        showSection('analytics');
      } else if (hash === 'tracking') {
        showSection('tracking');
      } else if (hash === 'recording') {
        showSection('recording');
      } else {
        showSection('assistant'); // Default to assistant
      }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleHashNavigation);

    // Pet management functions
    async function loadPets() {
      try {
        const res = await fetch(`/api/user-pets/${currentUser.uid}`);
        const pets = await res.json();
        const select = document.getElementById("pet-select");
        select.innerHTML = "";

        if (pets.length === 0) {
          // No pets found - add a placeholder option and show add-pet section
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No pets added yet";
          select.appendChild(option);
          
          console.log('No pets found - redirecting to add-pet section');
          hideQuickQuestions();
          
          // Auto-navigate to add-pet section if no pets exist
          setTimeout(() => showSection('add-pet'), 100);
          return;
        }

        pets.forEach(pet => {
          const option = document.createElement("option");
          option.value = pet.id;
          option.textContent = pet.name || pet.id;
          select.appendChild(option);
        });

        if (pets.length > 0) {
          selectedPet = pets[0].id;
          select.value = selectedPet;
          console.log('First pet selected:', selectedPet);
          
          // Show quick questions now that we have a pet selected
          showQuickQuestions();
        } else {
          console.log('No pets found');
          hideQuickQuestions();
        }
      } catch (error) {
        console.error('Error loading pets:', error);
      }
    }

    document.getElementById("pet-select").addEventListener("change", async (e) => {
      selectedPet = e.target.value;
      console.log('Pet selection changed to:', selectedPet);
      
      // Reset all assistant/chat/insight UI and state when pet changes
      resetAssistantState();
      
      if (selectedPet) {
        showQuickQuestions();
        
        // Preload pet data for faster chat responses
        await preloadPetData(selectedPet);
      } else {
        hideQuickQuestions();
      }
      
      // Get pet name for notification
      const petSelect = document.getElementById("pet-select");
      const petName = petSelect.options[petSelect.selectedIndex].text;
      console.log('Pet name:', petName);
      
      // Refresh analytics data immediately when pet changes
      const currentSection = document.querySelector('.section.active');
      if (currentSection && currentSection.id === 'analytics-section') {
        // Show notification that data is being loaded
        showNotification(`Loading analytics for ${petName}...`, 'info', 2000);
        
        // Update analytics section components
        loadDashboard(); // Load dashboard metrics
        updateCharts(); // Update visualization charts
        generateDailyHeadlines(); // Generate today's headlines for new pet
      }
      
      // Also refresh tracking section if it's active
      if (currentSection && currentSection.id === 'tracking-section') {
        showNotification(`Loading tracking data for ${petName}...`, 'info', 2000);
        loadRecentEntries(); // Load recent entries for new pet
      }
    });

    // Enhanced Pet Creation Function
    window.handleAddPetForm = async function(event) {
      event.preventDefault();
      
      if (!currentUser) {
        showNotification("Please log in first", 'error');
        return;
      }

      const form = document.getElementById('add-pet-form');
      const statusElement = document.getElementById('add-pet-status');
      
      // Get form data
      const formData = new FormData(form);
      const petData = {
        name: document.getElementById('pet-name').value.trim(),
        animal_type: document.getElementById('animal-type').value,
        breed: document.getElementById('pet-breed').value.trim(),
        age: document.getElementById('pet-age').value ? parseInt(document.getElementById('pet-age').value) : null,
        weight: document.getElementById('pet-weight').value ? parseFloat(document.getElementById('pet-weight').value) : null,
        gender: document.getElementById('pet-gender').value
      };

      // Validation
      if (!petData.name) {
        statusElement.textContent = "Please enter a pet name";
        statusElement.className = "status-message error";
        return;
      }

      if (!petData.animal_type) {
        statusElement.textContent = "Please select an animal type";
        statusElement.className = "status-message error";
        return;
      }

      try {
        statusElement.textContent = "Creating pet profile...";
        statusElement.className = "status-message";
        statusElement.style.display = "block";

        const response = await fetch(`/api/pets/${currentUser.uid}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(petData)
        });

        const result = await response.json();

        if (response.ok) {
          statusElement.textContent = `✅ ${petData.name} has been added successfully!`;
          statusElement.className = "status-message success";
          
          // Reset form
          form.reset();
          
          // Reload pets list
          await loadPets();
          
          // Navigate to assistant page with the new pet
          setTimeout(() => {
            showSection('assistant');
            showNotification(`Welcome ${petData.name}! You can now start using the health assistant.`, 'success');
          }, 1500);
          
        } else {
          throw new Error(result.error || 'Failed to create pet');
        }

      } catch (error) {
        console.error('Error creating pet:', error);
        statusElement.textContent = `❌ Error: ${error.message}`;
        statusElement.className = "status-message error";
      }
    };

    // Voice recording functions
    window.toggleRecording = async function () {
      if (!currentUser) {
        showNotification("Please log in first", 'error');
        return;
      }
      
      const petId = document.getElementById("pet-select").value;
      if (!petId) {
        showNotification("Please select a pet first", 'warning');
        return;
      }

      const button = document.getElementById("record-button");
      const statusElement = document.getElementById("status");
      const outputElement = document.getElementById("output");
      const loadingOverlay = document.getElementById("loading-overlay");

      // Prevent double-clicks during processing
      if (button.disabled) {
        console.log("Button disabled, ignoring click");
        return;
      }

      console.log("🔍 Current recording state:", isRecording);
      console.log("🔍 Button classes:", button.className);
      console.log("🔍 Button innerHTML:", button.innerHTML);

      if (!isRecording) {
        // Start recording
        try {
          console.log("🎙️ Starting recording...");
          button.disabled = true; // Prevent double-click
          
          const res = await fetch('/api/start_recording', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: currentUser.uid, pet: petId })
          });

          const data = await res.json();
          console.log('Start recording response:', data);
          
          if (data.status === "recording") {
            isRecording = true;
            button.innerHTML = '<i class="fas fa-stop"></i> <span>Stop Recording</span>';
            button.classList.add('recording');
            button.disabled = false; // Re-enable for stop action
            statusElement.textContent = "🎙️ Recording in progress... Click Stop when finished";
            statusElement.className = "status recording";
            statusElement.style.display = "block";
            outputElement.classList.remove("has-content");
            showNotification('Recording started! Speak clearly into your microphone.', 'info');
          } else {
            button.disabled = false; // Re-enable on error
            statusElement.textContent = "❌ Failed to start recording: " + (data.message || data.error || "Unknown error");
            statusElement.className = "status error";
            statusElement.style.display = "block";
            showNotification('Failed to start recording. Please try again.', 'error');
          }
        } catch (error) {
          console.error('Error starting recording:', error);
          button.disabled = false; // Re-enable on error
          statusElement.textContent = "❌ Failed to start recording";
          statusElement.className = "status error";
          statusElement.style.display = "block";
          showNotification('Network error. Please check your connection and try again.', 'error');
        }
      } else {
        // Stop recording
        try {
          console.log("🛑 Stopping recording...");
          button.disabled = true;
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Processing...</span>';
          statusElement.textContent = "⏳ Processing your recording...";
          statusElement.className = "status processing";
          statusElement.style.display = "block";
          loadingOverlay.style.display = "flex";
          
          const res = await fetch('/api/stop_recording', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: currentUser.uid, pet: petId })
          });

          const data = await res.json();
          console.log('Stop recording response:', data);
          
          // Handle both successful AI processing and basic transcription
          if (data.status === "success" && data.transcript && data.summary) {
            // Full AI processing successful
            document.getElementById("transcript-content").textContent = data.transcript;
            document.getElementById("summary-content").textContent = data.summary;
            
            // Show content type badge
            const contentTypeBadge = document.getElementById("content-type-badge");
            const contentType = data.content_type || "MIXED";
            const confidence = data.confidence || 0.5;
            
            let badgeClass = "badge-mixed";
            let badgeIcon = "fas fa-brain";
            let badgeText = contentType;
            
            if (contentType === "MEDICAL") {
              badgeClass = "badge-medical";
              badgeIcon = "fas fa-heartbeat";
              badgeText = "Health & Medical";
            } else if (contentType === "DAILY_ACTIVITY") {
              badgeClass = "badge-activity";
              badgeIcon = "fas fa-heart";
              badgeText = "Daily Life & Activities";
            } else {
              badgeText = "Mixed Content";
            }
            
            contentTypeBadge.innerHTML = `<i class="${badgeIcon}"></i> ${badgeText}`;
            contentTypeBadge.className = `content-type-badge ${badgeClass}`;
            contentTypeBadge.style.display = "inline-block";
            
            outputElement.classList.add("has-content");
            statusElement.textContent = `✅ ${badgeText} processed successfully!`;
            statusElement.className = "status success";
            
            showNotification('Recording processed successfully!', 'success');
            
            setTimeout(() => {
              statusElement.style.display = "none";
            }, 5000);
          } else if (data.status === "stopped" && data.transcript) {
            // Basic transcription successful (no AI processing)
            document.getElementById("transcript-content").textContent = data.transcript;
            document.getElementById("summary-content").textContent = "Transcription completed successfully. AI processing was not available.";
            
            // Hide content type badge for basic transcription
            const contentTypeBadge = document.getElementById("content-type-badge");
            contentTypeBadge.style.display = "none";
            
            outputElement.classList.add("has-content");
            statusElement.textContent = "✅ Recording transcribed successfully!";
            statusElement.className = "status success";
            
            showNotification('Recording transcribed successfully!', 'success');
            
            setTimeout(() => {
              statusElement.style.display = "none";
            }, 5000);
          } else if (data.status === "stopped" || data.status === "success") {
            // Recording stopped but no transcript (likely no speech detected)
            statusElement.textContent = "⚠️ Recording stopped but no speech was detected. Try speaking louder or closer to your microphone.";
            statusElement.className = "status error";
            showNotification('No speech detected in recording. Please try again.', 'warning');
          } else {
            // Error case
            const errorMsg = data.error || data.message || "Unknown error";
            statusElement.textContent = "❌ Error processing recording: " + errorMsg;
            statusElement.className = "status error";
            console.error('Recording processing error:', data);
            showNotification('Error processing recording: ' + errorMsg, 'error');
          }
        } catch (error) {
          console.error('Error stopping recording:', error);
          statusElement.textContent = "❌ Network error while processing recording";
          statusElement.className = "status error";
          showNotification('Network error. Please check your connection and try again.', 'error');
        } finally {
          // Always reset the button state regardless of success or failure
          console.log("🔄 Resetting recording UI state");
          loadingOverlay.style.display = "none";
          isRecording = false;
          button.innerHTML = '<i class="fas fa-microphone"></i> <span>Start Recording</span>';
          button.classList.remove('recording');
          button.disabled = false;
          
          // Ensure status is visible if there was an error
          if (statusElement.className.includes('error')) {
            statusElement.style.display = "block";
          }
        }
      }
    };

    // Smart Text Input Function with Classification
    window.submitPetText = async function() {
      if (!currentUser) return alert("User not authenticated");
      const petId = document.getElementById("pet-select").value;
      if (!petId) return alert("Please select a pet first");

      const textInput = document.getElementById("pet-input-text");
      const inputText = textInput.value.trim();
      const statusElement = document.getElementById("pet-input-status");
      const loadingOverlay = document.getElementById("loading-overlay");

      if (!inputText) {
        statusElement.textContent = "⚠️ Please enter some text first";
        statusElement.className = "status-message error";
        setTimeout(() => statusElement.style.display = "none", 3000);
        return;
      }

      try {
        // Show processing state
        statusElement.textContent = "🔄 Processing your note with AI...";
        statusElement.className = "status-message processing";
        statusElement.style.display = "block";
        loadingOverlay.style.display = "flex";

        const response = await fetch(`/api/pets/${petId}/textinput`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input: inputText })
        });

        const data = await response.json();
        loadingOverlay.style.display = "none";

        if (data.status === "success") {
          // Display the input text and AI analysis in the output area
          const outputElement = document.getElementById("pet-text-output");
          const textContentElement = document.getElementById("pet-text-content");
          const textSummaryElement = document.getElementById("pet-text-summary");
          const textTypeBadge = document.getElementById("pet-text-type-badge");
          
          if (textContentElement && textSummaryElement && textTypeBadge) {
            textContentElement.textContent = inputText;
            textSummaryElement.textContent = data.summary;
            
            // Show content type badge with enhanced styling
            const contentType = data.content_type || "MIXED";
            const confidence = ((data.confidence || 0.5) * 100).toFixed(0);
            const keywords = data.keywords || [];
            
            let badgeClass = "badge-mixed";
            let badgeIcon = "fas fa-brain";
            let badgeText = contentType;
            
            if (contentType === "MEDICAL") {
              badgeClass = "badge-medical";
              badgeIcon = "fas fa-heartbeat";
              badgeText = "Health & Medical";
            } else if (contentType === "DAILY_ACTIVITY") {
              badgeClass = "badge-activity";
              badgeIcon = "fas fa-heart";
              badgeText = "Daily Life & Activities";
            } else {
              badgeText = "Mixed Content";
            }
            
            textTypeBadge.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span class="content-type-badge ${badgeClass}">
                  <i class="${badgeIcon}"></i> ${badgeText}
                </span>
                <small style="color: #666; font-size: 0.85em;">Confidence: ${confidence}%</small>
              </div>
              ${keywords.length > 0 ? `<div style="font-size: 0.85em; color: #666;"><strong>Keywords:</strong> ${keywords.join(', ')}</div>` : ''}
            `;
            textTypeBadge.style.display = "block";
            
            // Show the output area
            if (outputElement) {
              outputElement.classList.add("has-content");
            }
          }
          
          // Clear the input
          textInput.value = "";
          
          // Show success message
          statusElement.textContent = `✅ ${badgeText} processed successfully!`;
          statusElement.className = "status-message success";
          statusElement.style.display = "block";
          
          // Auto-hide status after 5 seconds
          setTimeout(() => {
            statusElement.style.display = "none";
          }, 5000);

          // Show notification
          showNotification(`📝 ${badgeText} note added successfully!`, 'success', 3000);

          // If we're in analytics section, refresh the dashboard
          const currentSection = document.querySelector('.section.active');
          if (currentSection && currentSection.id === 'analytics-section') {
            setTimeout(() => {
              loadDashboard();
              updateCharts();
            }, 1000);
          }

        } else {
          statusElement.textContent = `❌ Error: ${data.message || "Failed to process note"}`;
          statusElement.className = "status-message error";
          statusElement.style.display = "block";
          setTimeout(() => statusElement.style.display = "none", 5000);
        }

      } catch (error) {
        console.error('Error submitting text:', error);
        loadingOverlay.style.display = "none";
        statusElement.textContent = "❌ Network error. Please try again.";
        statusElement.className = "status-message error";
        statusElement.style.display = "block";
        setTimeout(() => statusElement.style.display = "none", 5000);
      }
    };

    // Analytics form handlers
    function setupAnalyticsFormHandlers() {
      console.log("Setting up analytics form handlers...");
      
      // PDF upload form handler
      const pdfForm = document.getElementById("pdf-form");
      if (pdfForm) {
        pdfForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          if (!currentUser) {
            alert("User not authenticated");
            return;
          }
          
          const petId = document.getElementById("pet-select").value;
          if (!petId) {
            alert("Please select a pet first");
            return;
          }
          
          const fileInput = document.getElementById("pdf-file");
          const file = fileInput.files[0];
          
          if (!file) {
            alert("Please select a PDF file");
            return;
          }
          
          if (file.type !== "application/pdf") {
            alert("Please select a valid PDF file");
            return;
          }
          
          if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert("File size too large. Please select a file under 10MB");
            return;
          }
          
          try {
            // Show loading state
            const resultBox = document.getElementById("pdf-result");
            resultBox.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Uploading and analyzing PDF...</div>';
            resultBox.classList.add("has-content");
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append("file", file);
            formData.append("uid", currentUser.uid);
            formData.append("pet", petId);
            
            const response = await fetch("/api/upload_pdf", {
              method: "POST",
              body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.summary) {
              resultBox.innerHTML = `
                <div style="color: #38a169; margin-bottom: 15px;">
                  <i class="fas fa-check-circle"></i> PDF uploaded and analyzed successfully!
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4ecdc4;">
                  <h4 style="margin-bottom: 10px;"><i class="fas fa-file-medical"></i> ${file.name}</h4>
                  <div style="margin-bottom: 10px;"><strong>AI Summary:</strong></div>
                  <div style="line-height: 1.6;">${data.summary}</div>
                  ${data.url ? `<div style="margin-top: 10px;"><a href="${data.url}" target="_blank" style="color: #667eea;"><i class="fas fa-external-link-alt"></i> View Original Document</a></div>` : ''}
                </div>
              `;
              
              // Clear the file input
              fileInput.value = "";
              
              // Show success notification
              showNotification("PDF uploaded and analyzed successfully!", "success");
              
            } else {
              throw new Error(data.error || "Failed to process PDF");
            }
            
          } catch (error) {
            console.error("PDF upload error:", error);
            const resultBox = document.getElementById("pdf-result");
            resultBox.innerHTML = `
              <div style="color: #e53e3e; padding: 15px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle"></i> Error uploading PDF: ${error.message}
              </div>
            `;
            showNotification("Error uploading PDF", "error");
          }
        });
      }
      
      // Set default times for forms
      const now = new Date();
      document.getElementById("diet-time").value = now.toTimeString().slice(0, 5);
      document.getElementById("medication-time").value = now.toTimeString().slice(0, 5);
      document.getElementById("bowel-time").value = now.toTimeString().slice(0, 5);
      
      // Diet form
      const dietForm = document.getElementById("diet-form");
      if (dietForm) {
        dietForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            food: document.getElementById("diet-food").value,
            quantity: document.getElementById("diet-quantity").value,
            time: document.getElementById("diet-time").value,
            type: document.getElementById("diet-type").value,
            notes: document.getElementById("diet-notes").value
          };
          await submitAnalyticsForm(formData, "diet");
          dietForm.reset();
        });
      }

      // Exercise form
      const exerciseForm = document.getElementById("exercise-form");
      if (exerciseForm) {
        exerciseForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            type: document.getElementById("exercise-type").value,
            duration: parseInt(document.getElementById("exercise-duration").value),
            intensity: document.getElementById("exercise-intensity").value,
            location: document.getElementById("exercise-location").value,
            notes: document.getElementById("exercise-notes").value
          };
          await submitAnalyticsForm(formData, "exercise");
          exerciseForm.reset();
        });
      }

      // Medication form
      const medicationForm = document.getElementById("medication-form");
      if (medicationForm) {
        medicationForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            name: document.getElementById("medication-name").value,
            dosage: document.getElementById("medication-dosage").value,
            time: document.getElementById("medication-time").value,
            frequency: document.getElementById("medication-frequency").value,
            purpose: document.getElementById("medication-purpose").value
          };
          await submitAnalyticsForm(formData, "medication");
          medicationForm.reset();
        });
      }

      // Grooming form
      const groomingForm = document.getElementById("grooming-form");
      if (groomingForm) {
        groomingForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const selectedTypes = Array.from(document.getElementById("grooming-type").selectedOptions)
            .map(option => option.value);
          const formData = {
            types: selectedTypes,
            duration: parseInt(document.getElementById("grooming-duration").value) || 0,
            products: document.getElementById("grooming-products").value,
            notes: document.getElementById("grooming-notes").value
          };
          await submitAnalyticsForm(formData, "grooming");
          groomingForm.reset();
        });
      }

      // Energy form
      const energyForm = document.getElementById("energy-form");
      if (energyForm) {
        energyForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            level: parseInt(document.getElementById("energy-level").value),
            notes: document.getElementById("energy-notes").value
          };
          await submitAnalyticsForm(formData, "energy_levels");
          energyForm.reset();
        });
      }

      // Bowel form
      const bowelForm = document.getElementById("bowel-form");
      if (bowelForm) {
        bowelForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            consistency: document.getElementById("bowel-consistency").value,
            time: document.getElementById("bowel-time").value,
            notes: document.getElementById("bowel-notes").value
          };
          await submitAnalyticsForm(formData, "bowel_movements");
          bowelForm.reset();
        });
      }

      // Exit form
      const exitForm = document.getElementById("exit-form");
      if (exitForm) {
        exitForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            type: document.getElementById("exit-type").value,
            duration: parseInt(document.getElementById("exit-duration").value) || 0,
            destination: document.getElementById("exit-destination").value
          };
          await submitAnalyticsForm(formData, "exit_events");
          exitForm.reset();
        });
      }

      // Weight form
      const weightForm = document.getElementById("weight-form");
      if (weightForm) {
        weightForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            value: parseFloat(document.getElementById("weight-value").value),
            unit: document.getElementById("weight-unit").value,
            method: document.getElementById("weight-method").value,
            time: document.getElementById("weight-time").value,
            notes: document.getElementById("weight-notes").value
          };
          await submitAnalyticsForm(formData, "weight");
          weightForm.reset();
        });
      }

      // Sleep form
      const sleepForm = document.getElementById("sleep-form");
      if (sleepForm) {
        sleepForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            duration: parseFloat(document.getElementById("sleep-duration").value),
            quality: document.getElementById("sleep-quality").value,
            location: document.getElementById("sleep-location").value,
            interruptions: parseInt(document.getElementById("sleep-interruptions").value) || 0,
            notes: document.getElementById("sleep-notes").value
          };
          await submitAnalyticsForm(formData, "sleep");
          sleepForm.reset();
        });
      }

      // Mood form
      const moodForm = document.getElementById("mood-form");
      if (moodForm) {
        moodForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const selectedTriggers = Array.from(document.getElementById("mood-triggers").selectedOptions)
            .map(option => option.value);
          const selectedBehaviors = Array.from(document.getElementById("mood-behavior").selectedOptions)
            .map(option => option.value);
          const formData = {
            level: parseInt(document.getElementById("mood-level").value),
            triggers: selectedTriggers,
            behavior: selectedBehaviors,
            time: document.getElementById("mood-time").value,
            notes: document.getElementById("mood-notes").value
          };
          await submitAnalyticsForm(formData, "mood");
          moodForm.reset();
        });
      }
    }

    // Tab functionality
    window.showTab = function(tabName) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Remove active class from all tab buttons
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => btn.classList.remove('active'));
      
      // Show selected tab content
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
    };

    // Submit analytics form data
    async function submitAnalyticsForm(formData, category) {
      if (!selectedPet) {
        showNotification("Please select a pet first", 'error');
        return;
      }

      try {
        const response = await fetch(`/api/pets/${selectedPet}/analytics/${category}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },

          body: JSON.stringify(formData)
        });

        if (response.ok) {
          showNotification(`${category.replace('_', ' ')} data saved successfully!`, 'success');
          await loadDashboard();
          await loadRecentEntries();
          await updateCharts();
        } else {
          showNotification('Failed to save data', 'error');
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        showNotification('Error saving data', 'error');
      }
    }

    // Load analytics dashboard
    async function loadDashboard() {
      if (!selectedPet) return;

      // Show loading state on metric cards
      const metricCards = document.querySelectorAll('.metric-card');
      metricCards.forEach(card => {
        const valueElement = card.querySelector('.metric-value');
        if (valueElement) {
          valueElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
      });

      try {
        const response = await fetch(`/api/pets/${selectedPet}/analytics/summary`);
        const data = await response.json();
        const summary = data.summary || {};
        
        // Update metric cards
        metricCards.forEach(card => {
          const category = card.dataset.category;
          const categoryData = summary[category] || { total: 0, this_week: 0, avg_daily: 0 };
          
          if (category === 'energy_levels') {
            // Calculate average energy level
            const recentEntries = categoryData.recent_entries || [];
            const avgEnergy = recentEntries.length > 0 
              ? recentEntries.reduce((sum, entry) => sum + (entry.level || 3), 0) / recentEntries.length
              : 0;
            card.querySelector('.metric-value').textContent = avgEnergy.toFixed(1);
          } else {
            card.querySelector('.metric-value').textContent = categoryData.total;
          }
        });
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
        // Reset loading states on error
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach(card => {
          const valueElement = card.querySelector('.metric-value');
          if (valueElement && valueElement.innerHTML.includes('fa-spinner')) {
            valueElement.textContent = '0';
          }
        });
      }
    }

    // Load recent entries
    async function loadRecentEntries() {
      if (!selectedPet) return;

      try {
        const response = await fetch(`/api/pets/${selectedPet}/analytics?days=7`);
        const data = await response.json();
        const entries = data.data || [];
        
        const container = document.getElementById('recent-entries');
        
        if (entries.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; color: #7f8c8d; padding: 40px;">
              <i class="fas fa-clock"></i>
              <p>No recent entries. Start tracking your pet's activities above!</p>
            </div>
          `;
          return;
        }

        // Sort by timestamp (most recent first)
        entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const html = entries.slice(0, 10).map(entry => {
          const date = new Date(entry.timestamp);
          const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          
          const icons = {
            diet: '🍽️',
            exercise: '🏃',
            medication: '💊',
            grooming: '✨',
            energy_levels: '⚡',
            bowel_movements: '💩',
            exit_events: '🚪',
            weight: '⚖️',
            sleep: '😴',
            mood: '😊',
            daily_activity: '📝',
            medical_notes: '🏥',
            mixed_notes: '📋'
          };
          
          const description = getEntryDescription(entry);
          
          return `
            <div class="recent-entry">
              <div class="entry-content">
                <div class="entry-category">${entry.category.replace('_', ' ')}</div>
                <div class="entry-description">${description}</div>
                <div class="entry-time">${timeStr}</div>
              </div>
              <div class="entry-icon">${icons[entry.category] || '📝'}</div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading recent entries:', error);
      }
    }

    function getEntryDescription(entry) {
      switch (entry.category) {
        case 'diet':
          return `${entry.food || 'Food'} - ${entry.type || 'meal'}`;
        case 'exercise':
          return `${entry.type || 'Exercise'} for ${entry.duration || 0} minutes`;
        case 'medication':
          return `${entry.name || 'Medication'} - ${entry.dosage || ''}`;
        case 'grooming':
          return `${Array.isArray(entry.types) ? entry.types.join(', ') : 'Grooming'}`;
        case 'energy_levels':
          return `Energy level: ${entry.level || 3}/5`;
        case 'bowel_movements':
          return `${entry.consistency || 'Normal'} consistency`;
        case 'exit_events':
          return `${entry.type || 'Exit'} - ${entry.destination || ''}`;
        case 'weight':
          return `Weight: ${entry.value || 0} ${entry.unit || 'lbs'}`;
        case 'sleep':
          return `Sleep: ${entry.duration || 0} hours - ${entry.quality || 'good'} quality`;
        case 'mood':
          return `Mood level: ${entry.level || 3}/5 - ${Array.isArray(entry.behavior) ? entry.behavior.join(', ') : 'mood logged'}`;
        case 'daily_activity':
          // Handle voice notes and daily activities
          if (entry.source === 'voice_note') {
            return `Voice note: ${entry.summary || entry.transcript || 'Daily activity recorded'}`;
          } else if (entry.source === 'text_input') {
            return `Text note: ${entry.summary || entry.input || 'Daily activity logged'}`;
          }
          return entry.summary || entry.notes || 'Daily activity logged';
        case 'medical_notes':
          // Handle medical notes from text input
          if (entry.source === 'text_input') {
            return `Medical note: ${entry.summary || entry.input || 'Medical information recorded'}`;
          }
          return entry.summary || entry.notes || 'Medical note logged';
        case 'mixed_notes':
          // Handle mixed content notes
          if (entry.source === 'text_input') {
            return `Mixed note: ${entry.summary || entry.input || 'Mixed content recorded'}`;
          }
          return entry.summary || entry.notes || 'Mixed content logged';
        default:
          return entry.summary || entry.notes || 'Activity logged';
      }
    }

    // Chart variables
    let activityChart, energyChart, dietChart, overviewChart, exerciseHistogram, medicationChart;

    // Enhanced update charts function
    async function updateCharts() {
      if (!selectedPet) return;

      // Show loading states on all charts
      const chartIds = ['activityChart', 'energyChart', 'dietChart', 'overviewChart', 'exerciseHistogram', 'medicationChart', 'activityHeatmap'];
      chartIds.forEach(chartId => showChartLoading(chartId));

      try {
        // Get visualization data from enhanced API
        const response = await fetch(`/api/pets/${selectedPet}/visualizations?days=30`);
        const data = await response.json();
        
        if (data.visualizations) {
          // Create/update all charts
          updateActivityChart(data.visualizations.weekly_activity);
          updateEnergyChart(data.visualizations.energy_distribution);
          updateDietChart(data.visualizations.diet_frequency);
          updateOverviewChart(data.visualizations.health_overview);
          updateExerciseHistogram(data.visualizations.exercise_histogram);
          updateMedicationChart(data.visualizations.medication_adherence);
          updateActivityHeatmap(data.visualizations.activity_heatmap);
        }
        
        // Hide loading states
        chartIds.forEach(chartId => hideChartLoading(chartId));
        
      } catch (error) {
        console.error('Error updating charts:', error);
        // Hide loading states on error and fallback to basic charts
        chartIds.forEach(chartId => hideChartLoading(chartId));
        await updateChartsBasic();
      }
    }

    // Fallback to basic chart functionality
    async function updateChartsBasic() {
      try {
        const response = await fetch(`/api/pets/${selectedPet}/analytics?days=30`);
        const data = await response.json();
        const entries = data.data || [];
        
        // Prepare data for charts
        const chartData = prepareChartData(entries);
        
        // Update Activity Chart
        updateActivityChart(chartData.activity);
        
        // Update Energy Chart
        updateEnergyChart(chartData.energy);
        
        // Update Diet Chart
        updateDietChart(chartData.diet);
        
        // Update Overview Chart
        updateOverviewChart(chartData.overview);
        
      } catch (error) {
        console.error('Error updating charts:', error);
      }
    }

    function prepareChartData(entries) {
      const last7Days = [];
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        last7Days.push(date.toISOString().split('T')[0]);
      }
      
      // Activity data (exercise entries + daily_activity entries per day)
      const activityData = last7Days.map(date => {
        return entries.filter(entry => 
          (entry.category === 'exercise' || entry.category === 'daily_activity') && 
          entry.timestamp.startsWith(date)
        ).length;
      });
      
      // Energy data
      const energyData = entries
        .filter(entry => entry.category === 'energy_levels')
        .map(entry => entry.level || 3);
      
      // Diet data (meals per type)
      const dietTypes = {};
      entries.filter(entry => entry.category === 'diet').forEach(entry => {
        const type = entry.type || 'meal';
        dietTypes[type] = (dietTypes[type] || 0) + 1;
      });
      
      // Overview data (entries per category)
      const overview = {};
      entries.forEach(entry => {
        const category = entry.category;
        overview[category] = (overview[category] || 0) + 1;
      });
      
      return {
        activity: { labels: last7Days.map(date => new Date(date).toLocaleDateString()), data: activityData },
        energy: energyData,
        diet: dietTypes,
        overview: overview
      };
    }

    // Helper function to show loading state on charts
    function showChartLoading(chartId) {
      const canvas = document.getElementById(chartId);
      if (canvas) {
        const container = canvas.parentElement;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'chart-loading';
        loadingDiv.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          color: #7f8c8d;
          z-index: 10;
          font-size: 14px;
        `;
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i><br><span style="margin-top: 8px; display: block;">Loading chart...</span>';
        
        // Remove existing loading div if present
        const existingLoading = container.querySelector('.chart-loading');
        if (existingLoading) {
          existingLoading.remove();
        }
        
        container.style.position = 'relative';
        container.appendChild(loadingDiv);
      }
    }

    // Helper function to hide chart loading state
    function hideChartLoading(chartId) {
      const canvas = document.getElementById(chartId);
      if (canvas) {
        const container = canvas.parentElement;
        const loadingDiv = container.querySelector('.chart-loading');
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }
    }

    // Enhanced chart update functions
    function updateActivityChart(input) {
      const ctx = document.getElementById('activityChart');
      if (!ctx) return;
      
      if (activityChart) activityChart.destroy();
      
      let chartConfig;
      
      // Handle both chartConfig object and raw data
      if (input && input.type && input.data) {
        // Input is already a chart configuration
        chartConfig = input;
      } else if (input && input.labels && input.data) {
        // Input is raw data, create chart config
        chartConfig = {
          type: 'line',
          data: {
            labels: input.labels,
            datasets: [{
              label: 'Exercise Sessions',
              data: input.data,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        };
      }
      
      if (chartConfig) {
        activityChart = new Chart(ctx, chartConfig);
      }
    }

    function updateEnergyChart(input) {
      const ctx = document.getElementById('energyChart');
      if (!ctx) return;
      
      if (energyChart) energyChart.destroy();
      
      let chartConfig;
      
      // Handle both chartConfig object and raw data array
      if (input && input.type && input.data) {
        // Input is already a chart configuration
        chartConfig = input;
      } else if (input && Array.isArray(input)) {
        // Input is raw data array, create histogram chart config
        const histogram = [0, 0, 0, 0, 0]; // for levels 1-5
        input.forEach(level => {
          if (level >= 1 && level <= 5) {
            histogram[level - 1]++;
          }
        });
        
        chartConfig = {
          type: 'bar',
          data: {
            labels: ['Very Low', 'Low', 'Medium', 'High', 'Very High'],
            datasets: [{
              label: 'Energy Level Frequency',
              data: histogram,
              backgroundColor: ['#ff6b6b', '#ffa726', '#ffcc02', '#66bb6a', '#42a5f5']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        };
      }
      
      if (chartConfig) {
        energyChart = new Chart(ctx, chartConfig);
      }
    }

    function updateDietChart(input) {
      const ctx = document.getElementById('dietChart');
      if (!ctx) return;
      
      if (dietChart) dietChart.destroy();
      
      let chartConfig;
      
      // Handle both chartConfig object and raw data
      if (input && input.type && input.data) {
        // Input is already a chart configuration
        chartConfig = input;
      } else if (input && input.labels && input.data) {
        // Input is raw data, create chart config
        chartConfig = {
          type: 'doughnut',
          data: {
            labels: input.labels,
            datasets: [{
              data: input.data,
              backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        };
      }
      
      if (chartConfig) {
        dietChart = new Chart(ctx, chartConfig);
      }
    }

    function updateOverviewChart(input) {
      const ctx = document.getElementById('overviewChart');
      if (!ctx) return;
      
      if (overviewChart) overviewChart.destroy();
      
      let chartConfig;
      
      // Handle both chartConfig object and raw data
      if (input && input.type && input.data) {
        // Input is already a chart configuration
        chartConfig = input;
      } else if (input && input.labels && input.datasets) {
        // Input is raw data, create chart config
        chartConfig = {
          type: 'radar',
          data: {
            labels: input.labels,
            datasets: input.datasets
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 5
              }
            }
          }
        };
      }
      
      if (chartConfig) {
        overviewChart = new Chart(ctx, chartConfig);
      }
    }

    function updateExerciseHistogram(chartConfig) {
      const ctx = document.getElementById('exerciseHistogram');
      if (!ctx) return;
      
      if (exerciseHistogram) exerciseHistogram.destroy();
      
      if (chartConfig && chartConfig.data) {
        exerciseHistogram = new Chart(ctx, chartConfig);
      }
    }

    function updateMedicationChart(chartConfig) {
      const ctx = document.getElementById('medicationChart');
      if (!ctx) return;
      
      if (medicationChart) medicationChart.destroy();
      
      if (chartConfig && chartConfig.data) {
        medicationChart = new Chart(ctx, chartConfig);
      }
    }

    function updateActivityHeatmap(heatmapData) {
      const container = document.getElementById('activityHeatmap');
      if (!container || !heatmapData) return;
      
      const { hours, activities, max_activity } = heatmapData;
      
      container.innerHTML = '';
      
      hours.forEach((hour, index) => {
        const activity = activities[index] || 0;
        const intensity = max_activity > 0 ? activity / max_activity : 0;
        
        const block = document.createElement('div');
        block.style.cssText = `
          width: 100%;
          height: 80px;
          background: rgba(102, 126, 234, ${0.1 + intensity * 0.8});
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.7rem;
          font-weight: 500;
          color: ${intensity > 0.5 ? 'white' : '#667eea'};
          position: relative;
          cursor: pointer;
          transition: all 0.2s ease;
        `;
        
        block.textContent = activity;
        block.title = `${hour}:00 - ${activity} activities`;
        
        block.addEventListener('mouseenter', () => {
          block.style.transform = 'scale(1.1)';
          block.style.zIndex = '10';
        });
        
        block.addEventListener('mouseleave', () => {
          block.style.transform = 'scale(1)';
          block.style.zIndex = '1';
        });
        
        container.appendChild(block);
      });
    }

    window.generateDailyHeadlines = async function() {
      if (!selectedPet) {
        showNotification("Please select a pet first", 'error');
        return;
      }

      const headlinesContainer = document.getElementById('daily-headlines');
      headlinesContainer.innerHTML = `
        <div style="text-align: center; color: rgba(255,255,255,0.8);">
          <i class="fas fa-spinner fa-spin"></i> Generating AI headlines...
        </div>
      `;

      try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`/api/pets/${selectedPet}/daily_routine`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: today })
        });

        if (response.ok) {
          const data = await response.json();
          const headlines = data.headlines || [];
          
          if (headlines.length === 0) {
            headlinesContainer.innerHTML = `
              <div style="text-align: center; color: rgba(255,255,255,0.8);">
                No activities recorded for today. Start tracking to see AI-generated headlines!
              </div>
            `;
            return;
          }
          
          const headlinesHtml = headlines.map(headline => `
            <div class="daily-headline">
              ${headline}
            </div>
          `).join('');
          
          headlinesContainer.innerHTML = headlinesHtml;
          
        } else {
          throw new Error('Failed to generate headlines');
        }
      } catch (error) {
        console.error('Error generating headlines:', error);
        headlinesContainer.innerHTML = `
          <div style="text-align: center; color: rgba(255,255,255,0.8);">
            <i class="fas fa-exclamation-triangle"></i> Error generating headlines
          </div>
        `;
      }
    };

    // Notes functions  
    async function loadMarkdown() {
      if (!selectedPet) return;
      
      try {
        const response = await fetch('/api/markdown');
        const data = await response.json();
        
        if (data.content) {
          document.getElementById('markdown-content').innerHTML = data.content;
        }
      } catch (error) {
        console.error('Error loading notes:', error);
      }
    }

    // Utility function for notifications
    window.showNotification = function(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      
      switch(type) {
        case 'success':
          notification.style.background = '#10b981';
          break;
        case 'error':
          notification.style.background = '#ef4444';
          break;
        default:
          notification.style.background = '#667eea';
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    window.logout = async function () {
      await signOut(auth);
      window.location.href = "/index.html";
    };

    // AI Assistant Functions
    async function loadAssistantData() {
      if (!selectedPet) return;
      
      // Update AI health summary with loading state
      const summaryDiv = document.getElementById('ai-health-summary');
      summaryDiv.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 2.5rem; margin-bottom: 10px;">🔄</div>
          <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">Loading Health Summary...</div>
          <div style="opacity: 0.9;">
            <i class="fas fa-spinner fa-spin"></i> Analyzing your pet's health data...
          </div>
        </div>
      `;
      
      try {
        // Load AI health summary
        const response = await fetch(`/api/pets/${selectedPet}/assistant_summary`);
        const data = await response.json();
        
        if (data.status === 'success' && data.summary) {
          summaryDiv.innerHTML = `
            <div style="text-align: left;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 2rem; margin-right: 10px;">🏥</div>
                <div style="font-size: 1.2rem; font-weight: 600;">AI Health Summary</div>
              </div>
              <div style="line-height: 1.6; opacity: 0.95; font-size: 0.95rem; white-space: pre-line;">
                ${data.summary}
              </div>
              <div style="margin-top: 15px; font-size: 0.85rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                Based on ${data.data_sources?.length || 0} data sources • Updated ${new Date().toLocaleString()}
              </div>
            </div>
          `;
        } else {
          summaryDiv.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 2.5rem; margin-bottom: 10px;">🤖</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">AI Assistant Ready</div>
              <div style="opacity: 0.9;">Ask me anything about your pet's health, behavior, or symptoms</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading assistant data:', error);
        summaryDiv.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">🤖</div>
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">AI Assistant Ready</div>
            <div style="opacity: 0.9;">Ask me anything about your pet's health, behavior, or symptoms</div>
          </div>
        `;
      }
    }

    async function loadInsightsData() {
      if (!selectedPet) return;
      
      // Update AI health summary with loading state
      const summaryDiv = document.getElementById('ai-health-summary');
      summaryDiv.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 2.5rem; margin-bottom: 10px;">🔄</div>
          <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">Loading Health Insights...</div>
          <div style="opacity: 0.9;">
            <i class="fas fa-spinner fa-spin"></i> Analyzing your pet's health patterns...
          </div>
        </div>
      `;
      
      try {
        // Load AI health summary
        const response = await fetch(`/api/pets/${selectedPet}/assistant_summary`);
        const data = await response.json();
        
        if (data.status === 'success' && data.summary) {
          summaryDiv.innerHTML = `
            <div style="text-align: left;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 2rem; margin-right: 10px;">🏥</div>
                <div style="font-size: 1.2rem; font-weight: 600;">AI Health Insights</div>
              </div>
              <div style="line-height: 1.6; opacity: 0.95; font-size: 0.95rem; white-space: pre-line;">
                ${data.summary}
              </div>
              <div style="margin-top: 15px; font-size: 0.85rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px;">
                Based on ${data.data_sources?.length || 0} data sources • Updated ${new Date().toLocaleString()}
              </div>
            </div>
          `;
        } else {
          summaryDiv.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 2.5rem; margin-bottom: 10px;">🔍</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">Ready for Analysis</div>
              <div style="opacity: 0.9;">Use the search tool above or ask the AI assistant questions to get personalized insights</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading insights data:', error);
        summaryDiv.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">🔍</div>
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">Ready for Analysis</div>
            <div style="opacity: 0.9;">Use the search tool above or ask the AI assistant questions to get personalized insights</div>
          </div>
        `;
      }
    }

    // Reset all assistant UI and state when pet changes
    function resetAssistantState() {
      console.log('Resetting assistant state for new pet...');
      
      // Reset assistant data loaded flag
      assistantDataLoaded = false;
      
      // Clear chat history - get the chat container and reset it to initial state
      const chatContainer = document.getElementById('chat-container');
      if (chatContainer) {
        chatContainer.innerHTML = `
          <div class="assistant-message">
            <div style="display: flex; align-items: flex-start; gap: 15px;">
              <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                🤖
              </div>
              <div style="background: white; padding: 20px; border-radius: 16px; border: 1px solid #e1e8ed; flex: 1; line-height: 1.6; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                <strong style="color: #667eea; font-size: 1.1rem;">Hello! I'm your Pet Health Assistant.</strong><br><br>
                I have access to all your pet's health data including:
                <br><br>
                🎙️ <strong>Voice recordings</strong> with AI summaries<br>
                📄 <strong>Medical documents</strong> and veterinary records<br>
                📊 <strong>Health tracking data</strong> and patterns<br>
                📝 <strong>Notes and observations</strong><br><br>
                <strong style="color: #667eea;">How can I help you today?</strong> Ask me about symptoms, patterns, medications, or anything related to your pet's health!
              </div>
            </div>
          </div>
        `;
      }
      
      // Clear chat input
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.value = '';
      }
      
      // Reset AI health summary to default state
      const summaryDiv = document.getElementById('ai-health-summary');
      if (summaryDiv) {
        summaryDiv.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">🤖</div>
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">AI Health Insights</div>
            <div style="opacity: 0.9;">Ask a question below or use the chat to get personalized health insights based on your pet's data</div>
          </div>
        `;
      }
      
      // Clear knowledge search input and results
      const knowledgeSearch = document.getElementById('knowledge-search');
      if (knowledgeSearch) {
        knowledgeSearch.value = '';
      }
      
      const knowledgeResults = document.getElementById('knowledge-results');
      if (knowledgeResults) {
        knowledgeResults.innerHTML = `
          <div style="text-align: center; color: #7f8c8d;">
            <i class="fas fa-book-medical"></i>
            <p>Search our veterinary knowledge base for symptoms, treatments, and health information</p>
          </div>
        `;
      }
      
      console.log('Assistant state reset complete');
    }

    window.sendChatMessage = async function() {
      console.log('sendChatMessage called');
      const input = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-chat');
      console.log('Chat input element:', input);
      
      if (!input) {
        console.error('Chat input element not found');
        showNotification('Chat input not found', 'error');
        return;
      }
      
      const message = input.value.trim();
      console.log('Message:', message);
      
      if (!message) {
        console.log('Empty message');
        showNotification('Please enter a message first', 'warning');
        input.focus();
        return;
      }
      
      if (!selectedPet) {
        console.log('No pet selected');
        showNotification('Please select a pet first', 'warning');
        return;
      }
      
      if (!currentUser) {
        console.log('User not authenticated');
        showNotification('Please log in first', 'error');
        return;
      }

      console.log('Adding user message to chat...');
      // Show loading state on button
      if (sendButton) {
        showLoadingState(sendButton, 'Sending');
      }
      input.disabled = true;
      
      // Add user message to chat
      addChatMessage(message, 'user');
      
      // Clear input and show loading
      input.value = '';
      updateCharacterCount('chat-input', 'char-count', 1000);
      console.log('Adding loading message...');
      addChatMessage('🤔 Analyzing your pet\'s data and generating response...', 'assistant', true);

      try {
        console.log('Sending request to API...');
        const response = await fetch(`/api/pets/${selectedPet}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query: message
          })
        });

        console.log('Response received:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        // Remove loading message and add real response
        removeLastChatMessage();
        
        if (data.status === 'success') {
          // Always add response text if available, even if empty
          if (data.response) {
          console.log('Adding assistant response...');
          addChatMessage(data.response, 'assistant');
          } else {
            console.log('No text response, checking for visualizations...');
          }
          
          // If sources are provided, add them
          if (data.sources && data.sources.length > 0) {
            console.log('Adding sources...');
            addChatSources(data.sources);
          }
          
          // If visualizations are provided, add them
          if (data.visualizations && Object.keys(data.visualizations).length > 0) {
            console.log('Adding visualizations...');
            addChatVisualizations(data.visualizations, data.visualization_description);
          } else if (!data.response) {
            // If no response text AND no visualizations, show helpful message
            console.log('No response text or visualizations available');
            addChatMessage('I\'m processing your request, but there might not be enough data available yet. Try asking about something else or add some data for your pet first.', 'assistant');
          }
          
          // Show function call information if available (for debugging)
          if (data.function_calls_made && data.function_calls_made.length > 0) {
            console.log('Function calls made:', data.function_calls_made);
          }
          
          // Load health insights on first interaction
          if (!assistantDataLoaded) {
            console.log('Loading health insights on first interaction...');
            assistantDataLoaded = true;
            loadInsightsData();
          }
        } else {
          console.error('API error:', data.error || 'Unknown error');
          console.error('Full response data:', data);
          addChatMessage('Sorry, I encountered an error processing your request: ' + (data.error || 'Unknown error'), 'assistant');
        }
        
        // Reset UI state
        if (sendButton) {
          hideLoadingState(sendButton);
        }
        input.disabled = false;
        input.focus();
        
      } catch (error) {
        console.error('Error sending chat message:', error);
        removeLastChatMessage();
        addChatMessage('Sorry, I\'m having trouble connecting right now. Please check your internet connection and try again.', 'assistant');
        
        // Reset UI state
        if (sendButton) {
          hideLoadingState(sendButton);
        }
        input.disabled = false;
        input.focus();
        showNotification('Failed to send message. Please try again.', 'error');
      }
    }

    // Enhanced markdown parser for chat responses
    window.parseMarkdown = function(text) {
      if (!text) return '';
      
      return text
        // Headers (###)
        .replace(/^### (.*$)/gim, '<h3 style="margin: 8px 0 4px 0; color: #2c3e50; font-size: 1.1em; font-weight: 600;">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 style="margin: 12px 0 6px 0; color: #2c3e50; font-size: 1.3em; font-weight: 700;">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 style="margin: 15px 0 8px 0; color: #2c3e50; font-size: 1.5em; font-weight: 800;">$1</h1>')
        
        // Bold text (**text**)
        .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #2c3e50;">$1</strong>')
        
        // Italic text (*text*)
        .replace(/\*(.*?)\*/g, '<em style="font-style: italic; color: #2c3e50;">$1</em>')
        
        // Code formatting (`text`)
        .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #667eea; font-size: 0.9em;">$1</code>')
        
        // Blockquotes (> text)
        .replace(/^> (.*$)/gim, '<blockquote style="margin: 6px 0; padding: 8px 12px; border-left: 4px solid #667eea; background: #f8fafc; color: #4a5568; font-style: italic;">$1</blockquote>')
        
        // Bullet points (• or -)
        .replace(/^[•\-] (.*$)/gim, '<li style="margin: 2px 0; padding-left: 8px;">$1</li>')
        
        // Numbered lists (1. 2. 3.)
        .replace(/^(\d+)\. (.*$)/gim, '<li style="margin: 2px 0; padding-left: 8px;">$2</li>')
        
        // Convert double line breaks to paragraph breaks for better spacing
        .replace(/\n\n/g, '</p><p style="margin: 4px 0; line-height: 1.5;">')
        
        // Convert single line breaks to <br> tags
        .replace(/\n/g, '<br>')
        
        // Wrap content in paragraphs
        .replace(/^(.+)$/gm, '<p style="margin: 4px 0; line-height: 1.5;">$1</p>')
        
        // Wrap lists in <ul> tags
        .replace(/(<li.*?<\/li>)/g, '<ul style="margin: 6px 0; padding-left: 16px;">$1</ul>')
        .replace(/<\/ul>\s*<ul>/g, '') // Merge consecutive ul tags
        .replace(/<ul[^>]*>\s*<\/ul>/g, '') // Remove empty ul tags
        
        // Clean up empty paragraphs
        .replace(/<p[^>]*>\s*<\/p>/g, '')
        .replace(/<p[^>]*>\s*<br>\s*<\/p>/g, '');
    }

    window.addChatMessage = function(message, sender, isLoading = false) {
      const container = document.getElementById('chat-container');
      const messageDiv = document.createElement('div');
      
      // Parse markdown for assistant messages only
      const processedMessage = sender === 'assistant' && !isLoading ? window.parseMarkdown(message) : message;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 12px; justify-content: flex-end;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; max-width: 70%; line-height: 1.6;">
              ${message}
            </div>
            <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0;">
              👤
            </div>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0;">
              🤖
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e1e8ed; flex: 1; line-height: 1.6; ${isLoading ? 'opacity: 0.7;' : ''}">
              ${isLoading ? '<i class="fas fa-spinner fa-spin"></i> ' : ''}${processedMessage}
            </div>
          </div>
        `;
      }
      
      if (isLoading) {
        messageDiv.classList.add('loading-message');
      }
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    window.addChatSources = function(sources) {
      const container = document.getElementById('chat-container');
      const sourcesDiv = document.createElement('div');
      
      sourcesDiv.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <div style="width: 40px; height: 40px; background: #e1e8ed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #667eea; font-size: 18px; flex-shrink: 0;">
            📚
          </div>
          <div style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e1e8ed; flex: 1; font-size: 0.9rem;">
            <strong>Sources:</strong><br>
            ${sources.map(source => `• ${source.type}: ${source.summary || source.content}`.slice(0, 100) + '...').join('<br>')}
          </div>
        </div>
      `;
      
      container.appendChild(sourcesDiv);
      container.scrollTop = container.scrollHeight;
    }

    window.addChatVisualizations = function(visualizations, description) {
      const container = document.getElementById('chat-container');

      // Remove any previous visualization blocks
      const prevVizBlocks = container.querySelectorAll('.chat-visualization-block');
      prevVizBlocks.forEach(block => block.remove());

      const vizDiv = document.createElement('div');
      vizDiv.classList.add('chat-visualization-block');
      
      // Global chart map to track chart instances
      window._chatCharts = window._chatCharts || {};
      
      // Prepare valid charts only
      const validCharts = Object.entries(visualizations).filter(([chartName, chartConfig]) => {
        try {
          console.log('Checking chart:', chartName, chartConfig);
          if (!chartConfig.data ||
              !chartConfig.data.labels ||
              !chartConfig.data.datasets ||
              !chartConfig.data.datasets.length) {
            return false;
          }
          const dataLen = chartConfig.data.datasets[0].data.length;
          const chartType = (chartConfig.type || chartName).toLowerCase();
          // For line, area, activity_trend, sleep_pattern, require at least 2 data points
          if (["line", "area", "activity_trend", "sleep_pattern", "trend"].some(type => chartType.includes(type))) {
            if (chartConfig.data.labels.length < 2 || dataLen < 2) return false;
          } else {
            // For others, require at least 1 data point
            if (chartConfig.data.labels.length < 1 || dataLen < 1) return false;
          }
          return true;
        } catch (e) {
          console.log('Chart filter error:', chartName, e);
          return false;
        }
      });
      
      // If no valid charts, do not show visualization container
      if (validCharts.length === 0) {
        const noDataDiv = document.createElement('div');
        noDataDiv.classList.add('chat-visualization-block');
        noDataDiv.innerHTML = `
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0;">
              📊
            </div>
            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e1e8ed; flex: 1; color: #aaa;">
              <div style="margin-bottom: 10px; color: #667eea; font-weight: 500;">
                No data available to display a visualization for this question.
              </div>
            </div>
          </div>
        `;
        container.appendChild(noDataDiv);
        container.scrollTop = container.scrollHeight;
        return;
      }
      
      // Create visualization container
      vizDiv.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <div style="width: 40px; height: 40px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0;">
            📊
          </div>
          <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e1e8ed; flex: 1;">
            <div style="margin-bottom: 10px; color: #667eea; font-weight: 500;">
              📈 Visualization: ${description || 'Data visualization'}
            </div>
            <div id="chat-visualizations" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(vizDiv);
      container.scrollTop = container.scrollHeight;
      
      // Render only valid charts after the container is added to DOM
      setTimeout(() => {
        const chartsContainer = vizDiv.querySelector('#chat-visualizations');
        chartsContainer.innerHTML = ''; // Clear any previous charts (no empty boxes)
        let chartIndex = 0;
        
        validCharts.forEach(([chartName, chartConfig]) => {
          const chartDiv = document.createElement('div');
          chartDiv.style.cssText = 'background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e1e8ed;';
          
          const canvasId = `chat-chart-${chartIndex}`;
          chartDiv.innerHTML = `
            <h4 style="margin-bottom: 10px; color: #2c3e50; text-transform: capitalize;">${chartName.replace(/_/g, ' ')}</h4>
            <canvas id="${canvasId}" width="300" height="200"></canvas>
          `;
          
          chartsContainer.appendChild(chartDiv);
          
          // Create chart after canvas is in DOM
          setTimeout(() => {
            try {
              const canvas = document.getElementById(canvasId);
              if (canvas) {
                // Destroy previous chart if it exists
                if (window._chatCharts[canvasId]) {
                  window._chatCharts[canvasId].destroy();
                }
                window._chatCharts[canvasId] = new Chart(canvas, chartConfig);
              }
            } catch (error) {
              console.error(`Error creating chart ${chartName}:`, error);
              chartDiv.innerHTML = `
                <div style="text-align: center; color: #e53e3e; padding: 20px;">
                  <i class="fas fa-exclamation-triangle"></i>
                  <p>Error displaying chart: ${error.message}</p>
                </div>
              `;
            }
          }, 100);
          
          chartIndex++;
        });
      }, 100);
    }

    window.removeLastChatMessage = function() {
      const container = document.getElementById('chat-container');
      const loadingMessage = container.querySelector('.loading-message');
      if (loadingMessage) {
        loadingMessage.remove();
      }
    }

    window.showQuickQuestions = function() {
      const loading = document.getElementById('quick-questions-loading');
      const buttons = document.getElementById('quick-questions-buttons');
      if (loading) loading.style.display = 'none';
      if (buttons) buttons.style.display = 'block';
    }

    window.hideQuickQuestions = function() {
      const loading = document.getElementById('quick-questions-loading');
      const buttons = document.getElementById('quick-questions-buttons');
      if (buttons) buttons.style.display = 'none';
      if (loading) {
        loading.innerHTML = '<i class="fas fa-info-circle"></i> Please add a pet first to use quick questions';
        loading.style.display = 'block';
      }
    }

    window.askQuickQuestion = function(question) {
      console.log('Quick question clicked:', question);
      console.log('Selected pet:', selectedPet);
      console.log('Current user:', currentUser);
      
      if (!currentUser) {
        console.error('User not authenticated');
        showNotification('Please log in first', 'error');
        return;
      }
      
      if (!selectedPet) {
        console.error('No pet selected');
        showNotification('Please select a pet first', 'error');
        return;
      }
      
      const chatInput = document.getElementById('chat-input');
      if (!chatInput) {
        console.error('Chat input element not found');
        showNotification('Chat interface not found', 'error');
        return;
      }
      
      console.log('Setting chat input value to:', question);
      chatInput.value = question;
      
      console.log('Calling sendChatMessage...');
      sendChatMessage();
    }

    window.searchKnowledge = async function() {
      const query = document.getElementById('knowledge-search').value.trim();
      const resultsDiv = document.getElementById('knowledge-results');
      
      if (!query) {
        showNotification('Please enter a search query', 'error');
        return;
      }

      if (!selectedPet) {
        showNotification('Please select a pet first', 'error');
        return;
      }

      resultsDiv.innerHTML = `
        <div style="text-align: center; color: #667eea;">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Searching veterinary knowledge base...</p>
        </div>
      `;

      try {
        const response = await fetch(`/api/pets/${selectedPet}/knowledge_search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query })
        });

        const data = await response.json();
        
        if (data.status === 'success' && data.results && data.results.length > 0) {
          resultsDiv.innerHTML = data.results.map(result => `
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
              <h4 style="margin-bottom: 8px; color: #2c3e50;">${result.title}</h4>
              <p style="color: #666; line-height: 1.6;">${result.content}</p>
              <div style="margin-top: 8px; font-size: 0.85rem; color: #7f8c8d;">
                <strong>Category:</strong> ${result.category || 'General'} | 
                <strong>Severity:</strong> ${result.severity || 'N/A'} |
                <strong>Confidence:</strong> ${Math.round(result.score * 100)}%
              </div>
              ${result.symptoms && result.symptoms.length > 0 ? `
                <div style="margin-top: 8px; font-size: 0.85rem; color: #667eea;">
                  <strong>Related symptoms:</strong> ${result.symptoms.join(', ')}
                </div>
              ` : ''}
            </div>
          `).join('');
          
          // Load health insights on first interaction
          if (!assistantDataLoaded) {
            console.log('Loading health insights on first knowledge search...');
            assistantDataLoaded = true;
            loadInsightsData();
          }
        } else {
          resultsDiv.innerHTML = `
            <div style="text-align: center; color: #7f8c8d;">
              <i class="fas fa-search"></i>
              <p>No results found for "${query}". Try different keywords or broader terms.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error searching knowledge:', error);
        resultsDiv.innerHTML = `
          <div style="text-align: center; color: #e53e3e;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error searching knowledge base. Please try again.</p>
          </div>
        `;
      }
    }

    // Enable Enter key for chat input and form handlers
    document.addEventListener('DOMContentLoaded', function() {
      const chatInput = document.getElementById('chat-input');
      const knowledgeSearch = document.getElementById('knowledge-search');
      const addPetForm = document.getElementById('add-pet-form');
      
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });
      }
      
      if (knowledgeSearch) {
        knowledgeSearch.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchKnowledge();
          }
        });
      }
      
      if (addPetForm) {
        addPetForm.addEventListener('submit', handleAddPetForm);
      }
    });

    // ===================== Pet Data Caching Functions =====================
    
    async function preloadPetData(petId) {
      // Preload pet data for faster subsequent queries
      if (!petId) return;
      
      try {
        console.log(`🔄 Preloading data for pet ${petId}...`);
        
        const response = await fetch(`/api/pets/${petId}/preload`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: 30 })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          console.log('✅ Pet data preloaded successfully:', result.data_summary);
          
          // Show success notification with data summary
          const summary = result.data_summary;
          const message = `🚀 ${summary.pet_name} data loaded: ${summary.analytics_entries} analytics, ${summary.voice_notes} voice notes, ${summary.text_inputs} text inputs`;
          showNotification(message, 'success', 3000);
          
          // Update cache status indicator if it exists
          updateCacheStatusIndicator(petId, true, summary);
          
        } else {
          console.error('❌ Failed to preload pet data:', result.message);
          showNotification('Failed to preload pet data', 'error', 3000);
        }
        
      } catch (error) {
        console.error('Error preloading pet data:', error);
        showNotification('Error preloading pet data', 'error', 3000);
      }
    }
    
    async function checkCacheStatus(petId) {
      // Check if pet data is cached
      if (!petId) return false;
      
      try {
        const response = await fetch(`/api/pets/${petId}/cache/status`);
        const result = await response.json();
        
        if (result.status === 'success' && result.cached) {
          console.log('✅ Pet data is cached:', result.cache_info);
          updateCacheStatusIndicator(petId, true, result.cache_info);
          return true;
        } else {
          console.log('⚠️ Pet data not cached');
          updateCacheStatusIndicator(petId, false);
          return false;
        }
        
      } catch (error) {
        console.error('Error checking cache status:', error);
        return false;
      }
    }
    
    async function clearPetCache(petId) {
      // Clear cached data for a pet
      if (!petId) return;
      
      try {
        const response = await fetch(`/api/pets/${petId}/cache/clear`, {
          method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          console.log('🗑️ Pet cache cleared successfully');
          showNotification('Pet data cache cleared', 'info', 2000);
          updateCacheStatusIndicator(petId, false);
        } else {
          console.error('❌ Failed to clear cache:', result.message);
        }
        
      } catch (error) {
        console.error('Error clearing cache:', error);
      }
    }
    
    function updateCacheStatusIndicator(petId, isCached, cacheInfo = null) {
      // Update UI indicators for cache status
      // Add cache status to pet selector if it exists
      const petSelect = document.getElementById("pet-select");
      if (petSelect && petSelect.value === petId) {
        // Find or create cache indicator
        let indicator = document.getElementById("cache-status-indicator");
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.id = "cache-status-indicator";
          indicator.style.cssText = `
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
          `;
          petSelect.parentElement.style.position = 'relative';
          petSelect.parentElement.appendChild(indicator);
        }
        
        if (isCached) {
          indicator.style.backgroundColor = '#38a169';
          indicator.style.color = 'white';
          indicator.innerHTML = '⚡';
          indicator.title = `Data cached: ${cacheInfo ? cacheInfo.analytics_entries + ' analytics entries' : 'Fast mode enabled'}`;
        } else {
          indicator.style.backgroundColor = '#e53e3e';
          indicator.style.color = 'white';
          indicator.innerHTML = '○';
          indicator.title = 'Data not cached - queries will be slower';
        }
      }
    }

    // Enhanced UX helper functions
    function addLoadingState(element) {
      if (element) {
        element.classList.add('loading');
        element.disabled = true;
      }
    }

    function removeLoadingState(element) {
      if (element) {
        element.classList.remove('loading');
        element.disabled = false;
      }
    }

    function validateFormField(fieldId, validationFn, errorMessage) {
      const field = document.getElementById(fieldId);
      const formGroup = field?.closest('.form-group');
      const errorDiv = document.getElementById(fieldId + '-error');

      if (!field) return true;

      const isValid = validationFn(field.value);
      
      if (formGroup) {
        formGroup.classList.remove('error', 'success');
        formGroup.classList.add(isValid ? 'success' : 'error');
      }

      if (errorDiv) {
        errorDiv.textContent = isValid ? '' : errorMessage;
        errorDiv.classList.toggle('show', !isValid);
      }

      return isValid;
    }

    function updateCharacterCount(textareaId, countId, maxLength) {
      const textarea = document.getElementById(textareaId);
      const counter = document.getElementById(countId);
      
      if (textarea && counter) {
        const count = textarea.value.length;
        counter.textContent = count;
        counter.style.color = count > maxLength * 0.9 ? '#e53e3e' : '#7f8c8d';
      }
    }

    function showFeedback(message, type = 'success', duration = 3000) {
      const feedback = document.createElement('div');
      feedback.className = `feedback-${type}`;
      feedback.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
      `;
      
      document.body.appendChild(feedback);
      
      setTimeout(() => {
        feedback.style.animation = 'slideInDown 0.3s ease reverse';
        setTimeout(() => feedback.remove(), 300);
      }, duration);
    }

    function copyToClipboard(text, feedbackMessage = 'Copied to clipboard!') {
      navigator.clipboard.writeText(text).then(() => {
        const copyFeedback = document.createElement('div');
        copyFeedback.className = 'copy-feedback show';
        copyFeedback.innerHTML = `<i class="fas fa-clipboard-check"></i> ${feedbackMessage}`;
        
        document.body.appendChild(copyFeedback);
        
        setTimeout(() => {
          copyFeedback.classList.remove('show');
          setTimeout(() => copyFeedback.remove(), 300);
        }, 2000);
      });
    }

    function updateFormProgress() {
      const form = document.getElementById('add-pet-form');
      const progressFill = document.getElementById('form-progress');
      
      if (!form || !progressFill) return;
      
      const fields = form.querySelectorAll('input[required], select[required]');
      const filledFields = Array.from(fields).filter(field => field.value.trim() !== '');
      const progress = fields.length > 0 ? (filledFields.length / fields.length) * 100 : 0;
      
      progressFill.style.width = `${progress}%`;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Enhanced pet selection with validation
    function validatePetSelection() {
      const petSelect = document.getElementById('pet-select');
      const petStatus = document.getElementById('pet-status');
      const errorDiv = document.getElementById('pet-select-error');
      
      if (!selectedPet) {
        if (errorDiv) {
          errorDiv.textContent = 'Please select a pet to continue';
          errorDiv.classList.add('show');
        }
        if (petStatus) {
          petStatus.className = 'status-indicator error';
          petStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Select Pet';
        }
        return false;
      }
      
      if (errorDiv) {
        errorDiv.classList.remove('show');
      }
      if (petStatus) {
        petStatus.className = 'status-indicator online';
        petStatus.innerHTML = '<i class="fas fa-circle"></i> Ready';
      }
      return true;
    }

    // Setup character counters and form validation
    document.addEventListener('DOMContentLoaded', function() {
      // Character counters
      const chatInput = document.getElementById('chat-input');
      const textInput = document.getElementById('pet-input-text');
      
      if (chatInput) {
        const charCounter = document.getElementById('char-count');
        if (charCounter) {
          chatInput.addEventListener('input', () => updateCharacterCount('chat-input', 'char-count', 1000));
        }
      }
      
      if (textInput) {
        const textCharCounter = document.getElementById('text-char-count');
        if (textCharCounter) {
          textInput.addEventListener('input', () => updateCharacterCount('pet-input-text', 'text-char-count', 2000));
        }
      }

      // Form progress tracking
      const addPetForm = document.getElementById('add-pet-form');
      if (addPetForm) {
        const formFields = addPetForm.querySelectorAll('input, select');
        formFields.forEach(field => {
          field.addEventListener('input', debounce(updateFormProgress, 300));
          field.addEventListener('change', updateFormProgress);
        });
      }

      // Real-time validation for add pet form
      const petName = document.getElementById('pet-name');
      const animalType = document.getElementById('animal-type');
      
      if (petName) {
        petName.addEventListener('blur', () => {
          validateFormField('pet-name', 
            value => value.trim().length >= 2,
            'Pet name must be at least 2 characters long'
          );
        });
      }
      
      if (animalType) {
        animalType.addEventListener('change', () => {
          validateFormField('animal-type',
            value => value !== '',
            'Please select an animal type'
          );
        });
      }

      // Auto-save indicators for forms
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('input', debounce(() => {
          const statusIndicator = form.querySelector('.status-indicator.saving');
          if (statusIndicator) {
            statusIndicator.style.display = 'inline-flex';
            setTimeout(() => {
              statusIndicator.style.display = 'none';
            }, 1000);
          }
        }, 1000));
      });
    });

    // Enable keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + Enter to send chat message
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.id === 'chat-input') {
          e.preventDefault();
          sendChatMessage();
        }
      }
      
      // Escape to close any open modals or reset focus
      if (e.key === 'Escape') {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.blur) {
          activeElement.blur();
        }
      }
    });

    // ===================== Enhanced UX JavaScript Functions =====================

    // Smart Notification System
    function showNotification(message, type = 'info', duration = 4000) {
        const notification = document.createElement('div');
        notification.className = `notification-toast ${type}`;
        
        const icon = type === 'success' ? '✓' : 
                     type === 'error' ? '✕' : 
                     type === 'warning' ? '⚠' : 'ℹ';
        
        notification.innerHTML = `
            <span style="font-size: 16px;">${icon}</span>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Trigger animation
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Auto remove
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    document.body.removeChild(notification);
                }
            }, 400);
        }, duration);
    }

    // Enhanced Loading States
    function showLoadingState(element, message = 'Loading') {
        const originalContent = element.innerHTML;
        element.dataset.originalContent = originalContent;
        element.innerHTML = `
            <span class="loading-dots">${message}</span>
        `;
        element.disabled = true;
        element.classList.add('loading-shimmer');
    }

    function hideLoadingState(element) {
        if (element.dataset.originalContent) {
            element.innerHTML = element.dataset.originalContent;
            delete element.dataset.originalContent;
        }
        element.disabled = false;
        element.classList.remove('loading-shimmer');
    }

    // Smart Form Validation with Real-time Feedback
    function setupSmartValidation() {
        const inputs = document.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
            // Skip if already processed
            if (input.dataset.validationSetup) return;
            input.dataset.validationSetup = 'true';
            
            // Add validation container
            if (!input.parentElement.querySelector('.validation-message')) {
                const validationDiv = document.createElement('div');
                validationDiv.className = 'validation-message';
                input.parentElement.style.position = 'relative';
                input.parentElement.appendChild(validationDiv);
            }
            
            // Real-time validation
            input.addEventListener('input', () => validateField(input));
            input.addEventListener('blur', () => validateField(input));
            
            // Success indicators
            input.addEventListener('input', () => {
                if (input.value && !input.dataset.hasError) {
                    addSuccessIndicator(input);
                }
            });
        });
    }

    function validateField(input) {
        const validationDiv = input.parentElement.querySelector('.validation-message');
        if (!validationDiv) return true;
        
        let isValid = true;
        let message = '';
        
        // Email validation
        if (input.type === 'email' && input.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(input.value)) {
                isValid = false;
                message = 'Please enter a valid email address';
            }
        }
        
        // Required field validation
        if (input.required && !input.value.trim()) {
            isValid = false;
            message = 'This field is required';
        }
        
        // Phone validation
        if (input.name === 'phone' && input.value) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(input.value.replace(/[\s\-\(\)]/g, ''))) {
                isValid = false;
                message = 'Please enter a valid phone number';
            }
        }
        
        // Update validation UI
        if (!isValid) {
            validationDiv.textContent = message;
            validationDiv.classList.remove('success');
            validationDiv.classList.add('show');
            input.classList.add('error');
            input.dataset.hasError = 'true';
        } else {
            validationDiv.classList.remove('show');
            input.classList.remove('error');
            delete input.dataset.hasError;
            
            if (input.value) {
                validationDiv.textContent = 'Looks good!';
                validationDiv.classList.add('success');
                validationDiv.classList.add('show');
                setTimeout(() => validationDiv.classList.remove('show'), 2000);
            }
        }
        
        return isValid;
    }

    function addSuccessIndicator(input) {
        // Remove existing indicator
        const existing = input.parentElement.querySelector('.auto-save-status');
        if (existing) existing.remove();
        
        // Add new indicator
        const indicator = document.createElement('div');
        indicator.className = 'auto-save-status';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(indicator);
        
        // Remove after animation
        setTimeout(() => {
            if (indicator.parentElement) {
                indicator.parentElement.removeChild(indicator);
            }
        }, 2000);
    }

    // Smart Search with Suggestions
    function setupSmartSearch() {
        const searchInputs = document.querySelectorAll('input[type="search"], .search-input');
        
        searchInputs.forEach(input => {
            if (input.dataset.searchSetup) return;
            input.dataset.searchSetup = 'true';
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'search-suggestions';
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(suggestionsDiv);
            
            let searchTimeout;
            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (input.value.length > 2) {
                        showSearchSuggestions(input, suggestionsDiv);
                    } else {
                        hideSuggestions(suggestionsDiv);
                    }
                }, 300);
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.parentElement.contains(e.target)) {
                    hideSuggestions(suggestionsDiv);
                }
            });
        });
    }

    function showSearchSuggestions(input, suggestionsDiv) {
        // Smart suggestions based on current context
        const suggestions = [
            { icon: '🐕', text: `Search for "${input.value}" in pets` },
            { icon: '📋', text: `Find records containing "${input.value}"` },
            { icon: '💊', text: `Medications related to "${input.value}"` },
            { icon: '🏥', text: `Veterinarians named "${input.value}"` }
        ];
        
        suggestionsDiv.innerHTML = suggestions.map(suggestion => `
            <div class="suggestion-item" onclick="selectSuggestion('${suggestion.text}', this)">
                <span>${suggestion.icon}</span>
                <span>${suggestion.text}</span>
            </div>
        `).join('');
        
        suggestionsDiv.classList.add('show');
    }

    function hideSuggestions(suggestionsDiv) {
        suggestionsDiv.classList.remove('show');
    }

    function selectSuggestion(text, element) {
        const input = element.closest('.search-suggestions').previousElementSibling;
        input.value = text;
        hideSuggestions(element.parentElement);
        input.focus();
    }

    // Contextual Help System
    function setupContextualHelp() {
        if (document.querySelector('.contextual-help')) return;
        
        // Add contextual help button
        const helpButton = document.createElement('div');
        helpButton.className = 'contextual-help';
        helpButton.innerHTML = `
            <i class="fas fa-question"></i>
            <div class="help-tooltip">Get help with this page</div>
        `;
        document.body.appendChild(helpButton);
        
        helpButton.addEventListener('click', () => {
            showContextualHelp();
        });
    }

    function showContextualHelp() {
        const currentPage = getCurrentPageContext();
        const helpContent = getHelpContent(currentPage);
        
        showNotification(helpContent, 'info', 6000);
    }

    function getCurrentPageContext() {
        // Determine current page context
        const activeNavItem = document.querySelector('.nav-item.active');
        if (activeNavItem) {
            const navText = activeNavItem.textContent.toLowerCase();
            if (navText.includes('pet')) return 'pet-registration';
            if (navText.includes('health')) return 'health-records';
            if (navText.includes('chat')) return 'ai-chat';
            if (navText.includes('analytics')) return 'analytics';
        }
        
        if (document.querySelector('.pet-form')) return 'pet-registration';
        if (document.querySelector('.health-records')) return 'health-records';
        if (document.querySelector('.chat-container')) return 'ai-chat';
        if (document.querySelector('.analytics-dashboard')) return 'analytics';
        return 'general';
    }

    function getHelpContent(context) {
        const helpTexts = {
            'pet-registration': 'Fill out your pet\'s basic information. All required fields are marked with *. Use the voice input for easier data entry.',
            'health-records': 'Track your pet\'s health history. Upload photos of medical records for AI analysis. Click on any record to view details.',
            'ai-chat': 'Ask questions about your pet\'s health. The AI can analyze uploaded documents and provide personalized advice.',
            'analytics': 'View your pet\'s health trends and insights. Charts are interactive - click to drill down into specific data.',
                            'general': 'Welcome to PetPulse! Navigate using the menu. Need help? Contact support or check our FAQ.'
        };
        
        return helpTexts[context] || helpTexts.general;
    }

    // Auto-save Functionality
    function setupAutoSave() {
        const forms = document.querySelectorAll('form');
        
        forms.forEach(form => {
            if (form.dataset.autoSaveSetup) return;
            form.dataset.autoSaveSetup = 'true';
            
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                let saveTimeout;
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        autoSaveData(form, input);
                    }, 2000); // Save after 2 seconds of inactivity
                });
            });
        });
    }

    function autoSaveData(form, input) {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        // Save to localStorage as backup
        localStorage.setItem(`autoSave_${form.id || 'form'}`, JSON.stringify({
            data: data,
            timestamp: new Date().toISOString()
        }));
        
        // Show save indicator
        addSuccessIndicator(input);
        showDataSyncIndicator('Auto-saved', 'syncing');
        
        // Simulate API call
        setTimeout(() => {
            showDataSyncIndicator('Saved to cloud', 'success');
        }, 1000);
    }

    function showDataSyncIndicator(message, status) {
        let indicator = document.querySelector('.data-sync-indicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.className = 'data-sync-indicator';
            document.body.appendChild(indicator);
        }
        
        indicator.innerHTML = `
            <div class="sync-status-dot ${status}"></div>
            <span>${message}</span>
        `;
        
        indicator.classList.add('show');
        
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 3000);
    }

    // Keyboard Shortcuts
    let keyboardSetupComplete = false;
    function setupKeyboardShortcuts() {
        if (keyboardSetupComplete) return;
        keyboardSetupComplete = true;
        
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S for save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const activeForm = document.querySelector('form:focus-within');
                if (activeForm) {
                    showNotification('Form saved!', 'success');
                }
            }
            
            // Ctrl/Cmd + / for help
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                showContextualHelp();
            }
            
            // Escape to close modals/notifications
            if (e.key === 'Escape') {
                const notifications = document.querySelectorAll('.notification-toast');
                notifications.forEach(n => n.classList.remove('show'));
            }
        });
    }

    // Enhanced Voice Recording UX
    function enhanceVoiceRecording() {
        const voiceButtons = document.querySelectorAll('.voice-btn');
        
        voiceButtons.forEach(button => {
            if (button.dataset.voiceEnhanced) return;
            button.dataset.voiceEnhanced = 'true';
            
            const indicator = document.createElement('div');
            indicator.className = 'voice-indicator';
            button.parentElement.style.position = 'relative';
            button.parentElement.appendChild(indicator);
            
            button.addEventListener('click', () => {
                if (button.classList.contains('recording')) {
                    indicator.classList.add('active');
                    showNotification('Recording... Speak clearly into your microphone', 'info');
                } else {
                    indicator.classList.remove('active');
                    showNotification('Recording stopped', 'success');
                }
            });
        });
    }

    // Enhanced API Interaction with Better UX
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const [url, options] = args;
        
        // Show loading for API calls (but only for buttons, not automatic notifications)
        if (url && typeof url === 'string' && url.includes('/api/')) {
            const button = document.activeElement;
            if (button && button.tagName === 'BUTTON') {
                showLoadingState(button);
            }
        }
        
        return originalFetch.apply(this, args)
            .then(response => {
                // Hide loading without automatic success notifications
                const button = document.activeElement;
                if (button && button.tagName === 'BUTTON') {
                    hideLoadingState(button);
                }
                
                // Only show error notifications, not success ones
                if (!response.ok) {
                    showNotification('Something went wrong. Please try again.', 'error');
                }
                
                return response;
            })
            .catch(error => {
                // Hide loading and show error
                const button = document.activeElement;
                if (button && button.tagName === 'BUTTON') {
                    hideLoadingState(button);
                }
                
                showNotification('Connection error. Please check your internet.', 'error');
                throw error;
            });
    };

    // Initialize all UX enhancements
    function initializeUXEnhancements() {
        setupSmartValidation();
        setupSmartSearch();
        setupContextualHelp();
        setupAutoSave();
        setupKeyboardShortcuts();
        enhanceVoiceRecording();
        
        // Welcome message with delay
        setTimeout(() => {
            if (currentUser) {
                showNotification('Welcome back! Press Ctrl+/ for help', 'info', 4000);
            }
        }, 2000);
        
        // Re-initialize when new content is added
        const observer = new MutationObserver((mutations) => {
            let shouldReinitialize = false;
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    shouldReinitialize = true;
                }
            });
            
            if (shouldReinitialize) {
                setTimeout(() => {
                    setupSmartValidation();
                    setupSmartSearch();
                    enhanceVoiceRecording();
                }, 100);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // Initialize UX enhancements
    document.addEventListener('DOMContentLoaded', initializeUXEnhancements);

    // ===================== End Enhanced UX Functions =====================

    // Authentication
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "/index.html";
      } else {
        currentUser = user;
        loadPets().then(() => {
          // After pets are loaded, handle navigation
          handleHashNavigation();
          // Assistant data will be loaded on-demand when user interacts
        });
        setupAnalyticsFormHandlers();
      }
    });
  </script>
</body>
</html>
